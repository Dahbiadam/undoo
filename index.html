<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>UNDO ‚Äì Habit Tracker</title>
<meta name="description" content="UNDO - Quit Bad, Build Good. Track and improve your habits with AI coaching."/>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#7c3aed">
<link rel="apple-touch-icon" href="/icon-192.png">

<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  :root {
    --bg:#f8fafc;
    --card:#ffffff;
    --text:#0f1724;
    --muted:#6b7280;
    --border:#e6e7ea;
    --accent-from:#7c3aed;
    --accent-to:#ec4899;
    --green-from:#10b981;
    --green-to:#059669;
    --danger:#ef4444;
    --gold:#fbbf24;
    --radius: 16px;
    --shadow: 0 10px 30px rgba(2,6,23,0.06);
  }

  .dark {
    --bg:#0b1220;
    --card:#0f1724;
    --text:#ffffff;
    --muted:#94a3b8;
    --border:#22303b;
    --shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html { height: 100%; font-size: 16px; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    line-height: 1.5;
    min-height: 100vh;
    transition: background-color 0.5s, color 0.3s;
  }

  .wrap { max-width: 1200px; margin: 0 auto; padding: 1rem; }
  .card { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); transition: all 0.3s; }
  h1,h2,h3 { margin:0; font-weight:800; }
  .muted { color: var(--muted); }
  .small { font-size:0.875rem; }
  .heading { font-weight:800; }

  .btn {
    cursor:pointer;border:0;padding:0.75rem 1rem;border-radius:calc(var(--radius)-4px);
    font-weight:600;font-size:0.9375rem;display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;transition:all 0.2s;
  }
  .btn:active { transform: scale(0.98); }
  .btn-primary { background: linear-gradient(135deg,var(--accent-from),var(--accent-to)); color:white; }
  .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn-danger { background:var(--danger); color:white; }
  .btn-success { background: linear-gradient(135deg,var(--green-from),var(--green-to)); color:white; }
  .btn-gold { background: linear-gradient(135deg,#fbbf24,#f59e0b); color:#78350f; font-weight:700; }
  .btn-wide { width:100%; }
  .btn:disabled { opacity:0.5; cursor:not-allowed; }

  .premium-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    background: linear-gradient(135deg,#fbbf24,#f59e0b);
    color: #78350f;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 700;
    margin-left: 0.5rem;
  }

  input, select, textarea {
    width:100%; padding:0.75rem 1rem; border-radius:calc(var(--radius)-4px); border:2px solid var(--border);
    background:var(--card); color:var(--text); font-size:1rem; transition:border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus { outline:none; border-color:var(--accent-from); }
  textarea { min-height:100px; resize:vertical; }

  .flex { display:flex; }
  .grid { display:grid; }
  .gap-4 { gap:1rem; }
  .mb-4 { margin-bottom:1rem; }

  .dotbar { display:flex; gap:0.5rem; justify-content:center; margin-top:1rem; }
  .dot { height:0.5rem; border-radius:999px; background:#e5e7eb; width:0.5rem; transition:all 0.3s; }
  .dot.active { width:2rem; background: linear-gradient(90deg,var(--accent-from),var(--accent-to)); }

  .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; }
  .section-title { display:flex; gap:0.75rem; align-items:center; }

  header.appbar {
    position: sticky; top:0; z-index:40; padding:1rem 0; background:var(--card); backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border); box-shadow:var(--shadow);
  }

  .notif {
    position: fixed; left:50%; transform:translateX(-50%); top:1rem; z-index:80;
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to)); color:white; padding:1rem 1.5rem;
    border-radius:var(--radius); font-weight:600; box-shadow:var(--shadow); opacity:0; transition:opacity 0.3s; max-width:90%; text-align:center;
  }
  .notif.show { opacity:1; animation: bounce 0.5s; }
  @keyframes bounce { 0%,100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }

  .welcome-wrap { display:flex; align-items:center; justify-content:center; min-height:80vh; padding:1.5rem; }
  .options-list button { display:block; width:100%; text-align:left; padding:1rem; border-radius:calc(var(--radius)-4px);
    border:2px solid var(--border); background:transparent; color:var(--text); margin-bottom:0.75rem; font-weight:600; transition:all 0.2s; font-size:1rem; }
  .options-list button:hover { border-color:var(--accent-from); transform:translateX(4px); }

  .cols { display:grid; grid-template-columns:1fr; gap:1.5rem; }
  @media (min-width: 992px) { .cols { grid-template-columns:1fr 1fr; } }

  .habit-card { padding:1.5rem; border-radius:var(--radius); border:1px solid var(--border); margin-bottom:1.25rem; box-shadow:var(--shadow); }
  .green-panel { background: linear-gradient(135deg,var(--green-from),var(--green-to)); color:white; padding:1.5rem; border-radius:calc(var(--radius)-4px); text-align:center; box-shadow: 0 10px 30px rgba(16,185,129,0.3); }

  .calendar-grid { display:grid; grid-template-columns: repeat(10,1fr); gap:0.375rem; }
  .day { aspect-ratio:1/1; border-radius:4px; background:var(--border); transition:all 0.2s; }
  .day.done { background:var(--green-from); }

  .modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display:flex; align-items:center; justify-content:center; padding:1.25rem; z-index:60; opacity:0; transition:opacity 0.3s; }
  .modal-overlay.show { opacity:1; }
  .modal { max-width:640px; width:100%; background:var(--card); padding:1.5rem; border-radius:var(--radius); border:1px solid var(--border); transform: scale(0.95); opacity:0; transition:all 0.3s; max-height:90vh; overflow-y:auto; }
  .modal.show { transform: scale(1); opacity:1; }

  @keyframes spin { to { transform: rotate(360deg); } }
  .spin { animation: spin 1s linear infinite; }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
  .pulse { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }

  .stat-box { padding:1rem; border-radius:12px; text-align:center; }
  .stat-box.yellow { background: linear-gradient(135deg,#fef3c7,#fde68a); }
  .stat-box.orange { background: linear-gradient(135deg,#fed7aa,#fdba74); }
  .stat-box.red { background: linear-gradient(135deg,#fecaca,#fca5a5); }
  .dark .stat-box { background: rgba(255,255,255,0.05); }

  .chat-container {
    display: flex;
    flex-direction: column;
    height: 500px;
    max-height: 70vh;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .chat-message {
    display: flex;
    gap: 0.75rem;
    animation: slideIn 0.3s;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-message.user {
    flex-direction: row-reverse;
  }

  .chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .chat-bubble {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    word-wrap: break-word;
  }

  .chat-message.user .chat-bubble {
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to));
    color: white;
    border-bottom-right-radius: 0.25rem;
  }

  .chat-message.assistant .chat-bubble {
    background: var(--border);
    color: var(--text);
    border-bottom-left-radius: 0.25rem;
  }

  .chat-input-area {
    padding: 1rem;
    border-top: 1px solid var(--border);
  }

  .quick-questions {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }

  .quick-question-btn {
    padding: 0.5rem 0.75rem;
    border-radius: 999px;
    background: rgba(124,58,237,0.1);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 0.8125rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .quick-question-btn:hover {
    background: rgba(124,58,237,0.2);
    transform: translateY(-2px);
  }

  .typing-indicator {
    display: flex;
    gap: 0.25rem;
    padding: 0.75rem 1rem;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
    animation: typing 1.4s infinite;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
    30% { transform: translateY(-10px); opacity: 1; }
  }

  .challenge-card {
    padding: 1.5rem;
    border-radius: var(--radius);
    border: 2px solid var(--border);
    margin-bottom: 1.5rem;
    background: var(--card);
    transition: all 0.3s;
  }

  .challenge-card:hover {
    border-color: var(--accent-from);
    transform: translateY(-2px);
  }

  .challenge-card.active {
    border-color: var(--green-from);
    background: rgba(16,185,129,0.05);
  }

  .challenge-progress {
    height: 8px;
    background: var(--border);
    border-radius: 999px;
    overflow: hidden;
    margin: 1rem 0;
  }

  .challenge-progress-bar {
    height: 100%;
    background: linear-gradient(90deg,var(--green-from),var(--green-to));
    transition: width 0.3s;
  }

  .task-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 8px;
    background: rgba(255,255,255,0.5);
    margin-bottom: 0.5rem;
    transition: all 0.2s;
  }

  .task-item.completed {
    opacity: 0.6;
  }

  .task-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  .premium-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(124,58,237,0.95), rgba(236,72,153,0.95));
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius);
    backdrop-filter: blur(4px);
  }

  .spinner {
    width: 1rem;
    height: 1rem;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .habit-limit-banner {
    background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.2));
    border: 2px solid var(--gold);
    border-radius: var(--radius);
    padding: 1rem;
    margin-bottom: 1rem;
    text-align: center;
  }

  #emergency-overlay { position: fixed; inset: 0; background: linear-gradient(180deg, rgba(220,38,38,0.98), rgba(153,27,27,0.95)); display: none; z-index: 200; color: white; align-items: center; justify-content: center; padding: 1.25rem; }
  #emergency-overlay.show { display:flex; }
  .emergency-card { width:100%; max-width:720px; text-align:center; border-radius:18px; padding:1.5rem; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 40px rgba(239,68,68,0.45); border:1px solid rgba(255,255,255,0.06); }
  .emergency-head { font-size:2.5rem; font-weight:900; letter-spacing:2px; margin-bottom:0.5rem; }
  .emergency-sub { font-size:1.25rem; margin-bottom:1rem; opacity:0.95; }
  #emergency-video { width:100%; height:360px; max-height:60vh; background:black; border-radius:12px; object-fit:cover; border:4px solid rgba(0,0,0,0.2); }
  #camera-fallback { width:100%; height:360px; background:black; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; opacity:1; }

  #coach-text { font-size:1.125rem; min-height:60px; margin-top:1rem; font-weight:700; }
  .typing { display:inline-block; }

  @keyframes subtle-glow { 0% { box-shadow: 0 0 0px rgba(99,102,241,0.0), 0 0 0px rgba(99,102,241,0.0); } 50% { box-shadow: 0 0 10px rgba(99,102,241,0.4), 0 0 30px rgba(99,102,241,0.2); } 100% { box-shadow:0 0 0px rgba(99,102,241,0.0), 0 0 0px rgba(99,102,241,0.0); } }
  #breathingCircle { width:100%; height:100%; background: linear-gradient(135deg,#a5b4fc,#3b82f6); border-radius:50%; box-shadow:0 5px 15px rgba(0,0,0,0.1), 0 10px 30px rgba(0,0,0,0.05); transform: scale(0.3); will-change: transform, box-shadow; }
  .glowing { animation: subtle-glow 5s infinite alternate ease-in-out; }

  select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%236B7280' d='M10 12l-6-6h12z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position: right 0.75rem center; background-size:1.5em 1.5em; }

  #breathingContainer { display:flex; align-items:center; justify-content:center; width:70vw; height:70vw; max-width:300px; max-height:300px; margin:0 auto; }

  @media (max-width: 640px) {
    :root { --radius: 12px; }
    .modal { padding:1rem; }
    .welcome-wrap { padding:1rem; }
    .habit-card { padding:1rem; }
    .btn { padding:0.625rem 0.875rem; }
    input, select, textarea { padding:0.625rem 0.875rem; }
    .calendar-grid { gap:0.25rem; }
    .chat-bubble { max-width: 85%; }
    #header-buttons { display:none !important; }
    #btn-burger { display:inline-flex !important; }
  }

  #mobile-menu-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.5); 
    backdrop-filter: blur(8px);
    display: none; 
    z-index: 120; 
    align-items: flex-start; 
    justify-content: flex-end;
    padding: 0;
  }
  #mobile-menu-overlay.show { display:flex; }
  
  #mobile-menu-panel {
    width: 280px;
    height: 100vh;
    background: linear-gradient(180deg, #2c3e50 0%, #1a1f2e 100%);
    box-shadow: -5px 0 30px rgba(0,0,0,0.3);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  
  #mobile-menu-overlay.show #mobile-menu-panel {
    transform: translateX(0);
  }
  
  .mobile-menu-header {
    padding: 2rem 1.5rem 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .mobile-user-name {
    font-size: 1.5rem;
    font-weight: 800;
    color: white;
  }
  
  .mobile-menu-nav {
    flex: 1;
    padding: 1rem 0;
  }
  
  .mobile-menu-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    color: rgba(255,255,255,0.8);
    background: transparent;
    border: none;
    width: 100%;
    text-align: left;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.2s;
    position: relative;
    cursor: pointer;
  }
  
  .mobile-menu-item:hover,
  .mobile-menu-item.active {
    background: rgba(124,58,237,0.15);
    color: white;
  }
  
  .mobile-menu-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(180deg, var(--accent-from), var(--accent-to));
  }
  
  .mobile-menu-icon {
    font-size: 1.25rem;
    width: 24px;
    text-align: center;
  }
  
  .mobile-menu-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }

  .kpi { padding:1rem; background:var(--card); border:1px solid var(--border); border-radius:12px; text-align:center; }
  .num { font-size:1.75rem; font-weight:800; color:var(--text); margin-top:0.25rem; }
  .analytics-header { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:1rem; margin-bottom:1.5rem; }
  .chart-grid { display:grid; grid-template-columns:1fr; gap:1.5rem; }
  @media (min-width: 768px) { .chart-grid { grid-template-columns:1fr 1fr; } }
  .chart-card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:1.5rem; }
  .chart-scroll { overflow-x:auto; }
  .fixed-chart { min-width:300px; }
  .empty { text-align:center; padding:3rem; }
</style>
</head>
<body>
<div id="app">
  <div id="notification" class="notif" role="alert" aria-live="polite"></div>

  <header class="appbar" role="banner" id="main-header" style="display:none">
    <div class="wrap">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <div>
          <h1 class="flex heading" style="align-items:center;gap:0.625rem;font-size:1.75rem">
            <span>UNDO</span>
            <span id="premium-badge-header" style="display:none" class="premium-badge">
              üëë PREMIUM
            </span>
          </h1>
          <div id="greeting" class="small muted">Hey Friend!</div>
        </div>
        <div class="flex" style="gap:0.5rem;align-items:center">
          <button id="btn-burger" class="btn btn-ghost" title="Menu" aria-label="Open menu" style="display:none;font-size:1.25rem">‚ò∞</button>
          <div id="header-buttons" style="display:flex;gap:0.5rem;align-items:center">
            <button id="btn-home" class="btn btn-ghost" title="Go Home">üè†</button>
            <button id="btn-ai-coach" class="btn btn-ghost" title="AI Coach">ü§ñ</button>
            <button id="btn-challenges" class="btn btn-ghost" title="Challenges">üéØ</button>
            <button id="btn-breathe" class="btn btn-ghost" title="Breathing Exercise" aria-label="Open breathing exercise">üå¨Ô∏è</button>
            <button id="btn-analytics" class="btn btn-ghost" title="Analytics">üìä</button>
            <button id="btn-premium" class="btn btn-gold" title="Go Premium" style="display:none">üëë Premium</button>
            <button id="btn-dark" class="btn btn-ghost" title="Toggle Light/Dark Mode" aria-pressed="false">‚òÄÔ∏è</button>
            <button id="btn-settings" class="btn btn-ghost" title="Settings">‚öôÔ∏è</button>
            <button id="btn-logout" class="btn btn-ghost" title="Logout">üö™</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:1.5rem">
    <section id="welcome" class="welcome-wrap">
      <div class="card" style="max-width:760px;padding:2rem;width:100%">
        <div id="welcome-loading" style="display:none;text-align:center">
          <div class="spin" style="width:4rem;height:4rem;border-radius:999px;border:0.375rem solid rgba(124,58,237,0.2);border-top-color:var(--accent-from);margin:0 auto 1.5rem"></div>
          <div id="loading-text" class="heading" style="font-size:1.25rem;animation:pulse 2s infinite"></div>
        </div>

        <div id="welcome-content">
          <div style="text-align:center;margin-bottom:2rem">
            <div style="font-size:4rem;margin-bottom:0.5rem">‚Ü©Ô∏è</div>
            <h2 class="heading" style="font-size:2.5rem;margin:0.5rem 0">UNDO</h2>
            <div class="small muted" style="font-size:1.125rem">Quit Bad. Build Good.</div>
          </div>

          <div id="login-step" style="text-align:center; margin-bottom:2rem;">
            <h3 class="heading" style="font-size:1.5rem; margin-bottom:1rem">Sign In to UNDO</h3>
            <div id="g_id_onload"
                data-client_id="YOUR_GOOGLE_CLIENT_ID" 
                data-context="signin"
                data-ux_mode="popup"
                data-callback="handleCredentialResponse"
                data-auto_prompt="false">
            </div>
            <div class="g_id_signin"
                data-type="standard"
                data-shape="rectangular"
                data-theme="outline"
                data-text="signin_with"
                data-size="large"
                data-logo_alignment="left">
            </div>
            <div class="small muted" style="margin-top:1rem">Sign in with Google to securely save your progress and access the AI Coach.</div>
          </div>

          <div id="question-wrap" class="flex" style="flex-direction:column;gap:1rem;display:none">
            <div>
              <p id="q-text" class="heading" style="font-size:1.5rem;margin-bottom:1rem">What's your name?</p>
              <div id="q-input-wrap"></div>
            </div>

            <div class="flex" style="gap:0.75rem">
              <button id="btn-back-question" class="btn btn-ghost" style="flex:1;display:none">Back</button>
              <button id="btn-next-question" class="btn btn-primary" style="flex:1">Continue</button>
            </div>

            <div id="dotbar" class="dotbar"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="app-main" style="display:none">
      <div id="dashboard-view">
        <div id="habit-limit-banner" class="habit-limit-banner" style="display:none">
          <div style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem">
            ‚ö†Ô∏è Free Plan Limit: 3 Habits
          </div>
          <div class="small" style="margin-bottom:0.75rem">
            You've reached the free plan limit. Upgrade to Premium for unlimited habits!
          </div>
          <button id="upgrade-from-banner" class="btn btn-gold">
            üëë Upgrade to Premium
          </button>
        </div>

        <div class="cols">
          <div>
            <div class="section-header">
              <div class="section-title">
                <div style="font-size:1.5rem;color:var(--danger)">‚ùå</div>
                <div>
                  <div class="heading" style="font-size:1.5rem">Quit Habits (<span id="quit-count">0</span>)</div>
                  <div class="small muted">Track what you want to stop</div>
                </div>
              </div>
              <button id="add-quit" class="btn btn-danger">+ Add</button>
            </div>
            <div id="quit-list"></div>
          </div>

          <div>
            <div class="section-header">
              <div class="section-title">
                <div style="font-size:1.5rem;color:var(--green-from)">‚úÖ</div>
                <div>
                  <div class="heading" style="font-size:1.5rem">Build Habits (<span id="build-count">0</span>)</div>
                  <div class="small muted">Habits to build</div>
                </div>
              </div>
              <button id="add-build" class="btn btn-success">+ Add</button>
            </div>
            <div id="build-list"></div>
          </div>
        </div>
      </div>

      <div id="ai-coach-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">ü§ñ</span>
          AI Coach
          <span class="premium-badge">üëë PREMIUM</span>
        </h2>

        <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
          <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
              <div class="chat-message assistant">
                <div class="chat-avatar">ü§ñ</div>
                <div class="chat-bubble">
                  Hi! I'm your AI coach powered by GPT-4. I'm here to support you on your journey. How can I help you today?
                </div>
              </div>
            </div>

            <div class="chat-input-area">
              <div class="quick-questions" id="quick-questions">
                <button class="quick-question-btn" data-question="How do I stay motivated?">üí™ Stay motivated</button>
                <button class="quick-question-btn" data-question="I'm having cravings, help!">üÜò Craving help</button>
                <button class="quick-question-btn" data-question="Tips for my habits?">üí° Get tips</button>
                <button class="quick-question-btn" data-question="I relapsed, what now?">üîÑ After relapse</button>
              </div>
              
              <div style="display:flex;gap:0.5rem">
                <input 
                  type="text" 
                  id="chat-input" 
                  placeholder="Ask me anything about your habits..." 
                  style="flex:1"
                />
                <button id="chat-send" class="btn btn-primary" style="padding:0.75rem 1.5rem">
                  Send
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="challenges-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üéØ</span>
          Challenge Packs
          <span class="premium-badge">üëë PREMIUM</span>
        </h2>

        <div id="challenges-container"></div>
      </div>

      <div id="premium-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üëë</span>
          Go Premium
        </h2>

        <div class="card" style="padding:2rem;text-align:center;margin-bottom:2rem;background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(245,158,11,0.1))">
          <div style="font-size:3rem;margin-bottom:1rem">‚ú®</div>
          <h3 class="heading" style="font-size:2rem;margin-bottom:1rem">Unlock Your Full Potential</h3>
          <div class="small muted" style="font-size:1.125rem;margin-bottom:2rem">
            Get access to AI coaching, unlimited habits, and premium challenges
          </div>

          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem;text-align:left">
            <div>
              <div style="font-size:2rem;margin-bottom:0.5rem">ü§ñ</div>
              <div class="heading" style="font-size:1.125rem;margin-bottom:0.5rem">AI Coach</div>
              <div class="small muted">24/7 personalized coaching powered by GPT-4</div>
            </div>
            <div>
              <div style="font-size:2rem;margin-bottom:0.5rem">üéØ</div>
              <div class="heading" style="font-size:1.125rem;margin-bottom:0.5rem">Premium Challenges</div>
              <div class="small muted">Guided programs to conquer difficult habits</div>
            </div>
            <div>
              <div style="font-size:2rem;margin-bottom:0.5rem">‚ôæÔ∏è</div>
              <div class="heading" style="font-size:1.125rem;margin-bottom:0.5rem">Unlimited Habits</div>
              <div class="small muted">Track as many Quit or Build habits as you need</div>
            </div>
            <div>
              <div style="font-size:2rem;margin-bottom:0.5rem">üìä</div>
              <div class="heading" style="font-size:1.125rem;margin-bottom:0.5rem">Advanced Analytics</div>
              <div class="small muted">Deep insights into your progress and patterns</div>
            </div>
          </div>

          <button id="checkout-premium" class="btn btn-gold" style="font-size:1.25rem;padding:1rem 2.5rem;">
            Go Premium Now
          </button>

          <div class="small muted" style="margin-top:1rem">
            Cancel anytime. Start your free trial today.
          </div>
        </div>
      </div>

      <div id="breathing-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üå¨Ô∏è</span>
          Breathing Exercise
        </h2>

        <div class="card" style="padding:2rem;text-align:center">
          <div id="breathingContainer">
            <div id="breathingCircle" class="glowing"></div>
          </div>
          <div id="breathingStatus" class="heading" style="font-size:2rem;margin:1rem 0">INHALE ‚¨ÜÔ∏è</div>
          <div class="small muted" style="margin-bottom:1.5rem">
            Follow the circle as it expands and contracts.
          </div>

          <div class="flex gap-4" style="align-items:center;margin-bottom:1.5rem">
            <div style="flex:1">
              <label for="breath-mode" class="small muted" style="display:block;margin-bottom:0.25rem;text-align:left;font-weight:600">Mode</label>
              <select id="breath-mode">
                <option value="coherence">Coherence (5:5)</option>
                <option value="box">Box (4:4:4:4)</option>
                <option value="calm">Calm (4:6)</option>
                <option value="energy">Energy (2:4)</option>
              </select>
            </div>
            <div style="flex:1">
              <label for="breath-freq" class="small muted" style="display:block;margin-bottom:0.25rem;text-align:left;font-weight:600">Sound</label>
              <select id="breath-freq">
                <option value="off">Off</option>
                <option value="174">Deep (174 Hz)</option>
                <option value="432" selected>Natural (432 Hz)</option>
                <option value="528">Solfeggio (528 Hz)</option>
              </select>
            </div>
          </div>
          
          <div class="flex gap-4">
            <button id="start-breathing" class="btn btn-primary btn-wide">Start Session</button>
            <button id="stop-breathing" class="btn btn-ghost btn-wide" style="display:none">Stop Session</button>
          </div>
        </div>
      </div>

      <div id="analytics-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üìä</span>
          Analytics
          <span class="premium-badge">üëë PREMIUM</span>
        </h2>

        <div class="flex gap-4" style="align-items:flex-end;margin-bottom:1.5rem;border:1px solid var(--border);padding:1rem;border-radius:var(--radius)">
          <div style="flex:1">
            <label for="analytic-range" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Time Range</label>
            <select id="analytic-range">
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
            </select>
          </div>
          <div style="margin-top:auto">
            <button id="refreshAnalytics" class="btn btn-primary">Refresh</button>
          </div>
        </div>
        
        <div id="analyticsMain">
          <div id="kpiRow" class="analytics-header"></div>
          <div id="chartsWrap" class="chart-grid">
            <div class="chart-card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
                <div class="small muted" style="font-weight:600">7-Day Trend</div>
              </div>
              <div class="chart-scroll">
                <canvas id="chart7" class="fixed-chart" aria-label="7 day chart"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
                <div class="small muted" style="font-weight:600">Today - Hourly Progress</div>
              </div>
              <div class="chart-scroll">
                <canvas id="chart24" class="fixed-chart" aria-label="24 hour chart"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <div id="emptyState" class="empty" style="display:none;padding:3rem;text-align:center">
          <div style="font-size:3rem;opacity:0.3;margin-bottom:1rem">ü§∑</div>
          <div class="heading" style="font-size:1.25rem">Not Enough Data</div>
          <div class="small muted">Track your habits for a few days to see meaningful stats here!</div>
        </div>
      </div>

      <div id="settings-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">‚öôÔ∏è</span>
          Settings
        </h2>
        
        <div class="cols" style="grid-template-columns:1fr;max-width:768px">
          <div class="card" style="padding:1.5rem">
            <h3 class="heading" style="font-size:1.25rem;margin-bottom:1rem">Profile</h3>
            <div class="mb-4">
              <label for="setting-name" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Name</label>
              <input type="text" id="setting-name" placeholder="Your Name" />
            </div>
            <div class="mb-4">
              <label for="setting-email" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Email (Read-Only)</label>
              <input type="email" id="setting-email" placeholder="Email" readonly />
            </div>
            <div class="mb-4">
              <label for="setting-why" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">My Motivation/Why</label>
              <textarea id="setting-why" placeholder="Why are you changing your habits? (Used by AI Coach)"></textarea>
            </div>
            <button id="save-profile" class="btn btn-primary btn-wide">Save Profile</button>
          </div>

          <div class="card" style="padding:1.5rem">
            <h3 class="heading" style="font-size:1.25rem;margin-bottom:1rem">Data Management</h3>
            <div class="flex gap-4 mb-4">
              <button id="export-data-btn" class="btn btn-ghost" style="flex:1">Export Data</button>
              <input type="file" id="import-data-file" accept=".json" style="display:none" />
              <button id="import-data-btn" class="btn btn-ghost" style="flex:1">Import Data</button>
            </div>
            <button id="reset-data-btn" class="btn btn-danger btn-wide">Clear All Local Data</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="add-modal" class="modal-overlay">
    <div class="modal">
      <h3 id="modal-title" class="heading" style="font-size:1.5rem;margin-bottom:1rem">Add Habit</h3>
      <div class="mb-4">
        <label for="add-name" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Habit Name (e.g., 'Smoking', 'Running')</label>
        <input type="text" id="add-name" placeholder="e.g., Smoking" />
      </div>
      <div class="mb-4">
        <label for="add-category" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Category</label>
        <select id="add-category"></select>
      </div>

      <div id="quit-fields">
        <div class="mb-4">
          <label for="add-startdate" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Date/Time of Last Relapse (or start time)</label>
          <input type="datetime-local" id="add-startdate" />
        </div>
      </div>
      
      <div id="build-fields" style="display:none">
        <div class="flex gap-4 mb-4" style="align-items:flex-end">
          <div style="flex:1">
            <label for="add-daily-goal" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Daily Goal Amount</label>
            <input type="number" id="add-daily-goal" placeholder="e.g., 10" min="1" value="1" />
          </div>
          <div style="flex:1">
            <label for="add-unit" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Unit Type</label>
            <select id="add-unit">
              <option value="times">times</option>
              <option value="minutes">minutes</option>
              <option value="pages">pages</option>
              <option value="ml">ml</option>
              <option value="custom">Custom</option>
            </select>
          </div>
        </div>
        <div id="custom-unit-wrap" class="mb-4" style="display:none">
          <label for="add-custom-unit" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Custom Unit Label (e.g., 'steps', 'pushups')</label>
          <input type="text" id="add-custom-unit" placeholder="e.g., steps" />
        </div>
      </div>

      <div class="flex gap-4">
        <button id="add-cancel" class="btn btn-ghost" style="flex:1">Cancel</button>
        <button id="add-save" class="btn btn-primary" style="flex:1">Save Habit</button>
      </div>
    </div>
  </div>

  <div id="relapse-modal" class="modal-overlay">
    <div class="modal" style="max-width:500px;text-align:center">
      <div style="font-size:3rem;margin-bottom:0.5rem">‚ö†Ô∏è</div>
      <h3 class="heading" style="font-size:1.5rem;margin-bottom:0.5rem">Confirm Relapse</h3>
      <div class="small muted" style="margin-bottom:1rem">
        This will reset the streak for <span id="relapse-habit-name" style="font-weight:600"></span>.
      </div>
      
      <div class="mb-4">
        <label for="relapse-time" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Time of Relapse</label>
        <input type="datetime-local" id="relapse-time" />
      </div>

      <div class="mb-4">
        <label for="relapse-reason" class="small muted" style="display:block;margin-bottom:0.25rem;font-weight:600">Reason/Trigger (Optional)</label>
        <textarea id="relapse-reason" placeholder="What led to the relapse? (For tracking patterns)"></textarea>
      </div>

      <div class="flex gap-4">
        <button id="relapse-cancel" class="btn btn-ghost" style="flex:1">Cancel</button>
        <button id="relapse-confirm" class="btn btn-danger" style="flex:1">Reset Streak</button>
      </div>
    </div>
  </div>

  <div id="emergency-overlay">
    <div class="emergency-card">
      <div class="emergency-head">EMERGENCY BUTTON</div>
      <div class="emergency-sub">URGE SURVIVAL MODE ACTIVATED</div>
      
      <div id="camera-fallback" style="display:none">
        <div class="heading">Camera Permission Denied or Unavailable</div>
      </div>
      <video id="emergency-video" autoplay playsinline style="display:none"></video>
      
      <div id="coach-text-wrap" style="padding:1rem 0;background:rgba(0,0,0,0.2);border-radius:8px;margin-top:1.5rem">
        <div style="font-size:1.125rem;font-weight:700" id="coach-line">
          Hold on a moment. Focus on the screen.
        </div>
      </div>
      
      <div class="flex gap-4" style="margin-top:1.5rem">
        <button id="emergency-done" class="btn btn-success btn-wide" style="flex:1; padding:1rem;"> Urge Passed! </button>
        <button id="emergency-relapse" class="btn btn-danger btn-wide" style="flex:1; padding:1rem;"> I relapsed, reset timer </button>
      </div>
    </div>
  </div>

  <div id="mobile-menu-overlay">
    <div id="mobile-menu-panel">
      <div class="mobile-menu-header">
        <div class="mobile-user-name" id="mobile-menu-name">Hey Friend</div>
        <div class="small" style="color:rgba(255,255,255,0.6);">
          <span id="mobile-menu-email">Not Logged In</span>
          <span id="mobile-menu-premium" class="premium-badge" style="display:none;">üëë PREMIUM</span>
        </div>
      </div>
      <nav class="mobile-menu-nav">
        <button class="mobile-menu-item" data-page="dashboard">
          <span class="mobile-menu-icon">üè†</span> Dashboard
        </button>
        <button class="mobile-menu-item" data-page="ai-coach">
          <span class="mobile-menu-icon">ü§ñ</span> AI Coach
        </button>
        <button class="mobile-menu-item" data-page="challenges">
          <span class="mobile-menu-icon">üéØ</span> Challenges
        </button>
        <button class="mobile-menu-item" data-page="breathing">
          <span class="mobile-menu-icon">üå¨Ô∏è</span> Breathing
        </button>
        <button class="mobile-menu-item" data-page="analytics">
          <span class="mobile-menu-icon">üìä</span> Analytics
        </button>
        <button class="mobile-menu-item" data-page="premium">
          <span class="mobile-menu-icon">üëë</span> Premium
        </button>
        <button class="mobile-menu-item" data-page="settings">
          <span class="mobile-menu-icon">‚öôÔ∏è</span> Settings
        </button>
      </nav>
      <div class="mobile-menu-footer">
        <div class="flex gap-4" style="margin-bottom:1rem;align-items:center">
          <span style="color:white;font-weight:600">Dark Mode</span>
          <button id="mobile-menu-dark-toggle" class="btn btn-ghost" title="Toggle Light/Dark Mode" aria-pressed="false" style="margin-left:auto;color:white;border-color:rgba(255,255,255,0.3)">‚òÄÔ∏è</button>
        </div>
        <button id="mobile-menu-logout" class="btn btn-danger btn-wide">
          üö™ Logout
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script>
// --- Global State ---
let state = {
  isLoggedIn: false,
  isPremium: false,
  screen: 'welcome', // 'welcome' or 'dashboard'
  page: 'dashboard', // 'dashboard', 'ai-coach', 'challenges', etc.
  userData: {
    name: 'Friend',
    email: '',
    why: 'To live a healthier, happier life.',
    challengeStart: null,
  },
  quitHabits: [],
  buildHabits: [],
  chatHistory: [],
  answers: {}, // For onboarding
  questionIndex: 0,
  relapseModalOpen: false,
  emergencyHabit: null,
  analyticsChart: null,
};

// --- Config / Constants ---
const GOOGLE_CLIENT_ID = "YOUR_GOOGLE_CLIENT_ID"; // REMEMBER TO SET THIS
const HABIT_ICONS = {
  smoking: 'üö¨', alcohol: 'üçª', sugar: 'üç©', porn: 'üîû', social_media: 'üì±', gaming: 'üéÆ', procrastination: 'üìù',
  exercise: 'üèãÔ∏è', reading: 'üìö', meditation: 'üßò', water: 'üíß', sleep: 'üò¥', money: 'üí∞', other: 'üí°'
};
const ALL_CATEGORIES = {
  smoking: { type: 'quit', label: 'Smoking üö¨' }, alcohol: { type: 'quit', label: 'Alcohol üçª' }, sugar: { type: 'quit', label: 'Sugar/Junk Food üç©' }, porn: { type: 'quit', label: 'Porn/Masturbation üîû' }, social_media: { type: 'quit', label: 'Social Media Scrolling üì±' }, gaming: { type: 'quit', label: 'Gaming üéÆ' }, procrastination: { type: 'quit', label: 'Procrastination üìù' },
  exercise: { type: 'build', label: 'Exercise üèãÔ∏è' }, reading: { type: 'build', label: 'Reading üìö' }, meditation: { type: 'build', label: 'Meditation üßò' }, water: { type: 'build', label: 'Drinking Water üíß' }, sleep: { type: 'build', label: 'Better Sleep üò¥' }, money: { type: 'build', label: 'Saving Money üí∞' }, other: { type: 'both', label: 'Other/Custom üí°' }
};
const QUESTIONS = [
  { q: "What's your name?", type: 'input', key: 'name', inputType: 'text', default: '' },
  { q: "What is the biggest thing you want to **QUIT**?", type: 'select', key: 'quitCategory', options: Object.entries(ALL_CATEGORIES).filter(([, v]) => v.type !== 'build').map(([k, v]) => ({ value: k, label: v.label })) },
  { q: "What new positive habit do you want to **BUILD**?", type: 'select', key: 'buildCategory', options: Object.entries(ALL_CATEGORIES).filter(([, v]) => v.type !== 'quit').map(([k, v]) => ({ value: k, label: v.label })) },
  { q: "Why are you doing this? What is your biggest motivation?", type: 'input', key: 'why', inputType: 'textarea', default: 'To live a healthier, happier life.' }
];
const COACH_LINES = [
    "This feeling is temporary. Focus on your breathing for a moment.",
    "Acknowledge the urge, but don't act on it. You are in control.",
    "Remember your 'Why'. Look at yourself on the screen. Who do you want to be?",
    "Wait 10 minutes. Distract yourself with a simple physical task.",
    "You've survived urges before. This one is no different. Breathe and let it pass."
];
const CHALLENGE_PACKS = {
    'dopamine-30': {
        id: 'dopamine-30',
        name: 'üß† 30-Day Dopamine Detox',
        description: 'Reset your reward system to find joy in simple things again.',
        duration: 30,
        tasks: [
            { day: 1, task: 'No sugar for 24 hours', completed: false },
            { day: 3, task: 'Spend 1 hour distraction-free (no phone/PC)', completed: false },
            { day: 7, task: 'Complete 3 non-digital hobbies this week', completed: false },
            { day: 10, task: 'Journal about boredom', completed: false },
            { day: 14, task: 'Read a book for 30 minutes', completed: false },
            { day: 21, task: 'Plan your long-term dopamine budget', completed: false },
            { day: 30, task: 'Evaluate your progress and new joy level', completed: false }
        ]
    },
    'fit-60': {
        id: 'fit-60',
        name: 'üèãÔ∏è 60-Day Fitness Foundation',
        description: 'Establish a non-negotiable routine for strength and endurance.',
        duration: 60,
        tasks: [
            { day: 1, task: 'Walk 10 minutes (easy start)', completed: false },
            { day: 7, task: 'Complete 3 structured workouts this week', completed: false },
            { day: 15, task: 'Measure and record baseline weight/body composition', completed: false },
            { day: 30, task: 'Complete a 30-minute workout, 5 times this week', completed: false },
            { day: 45, task: 'Try a new form of exercise (yoga, swimming, etc.)', completed: false },
            { day: 60, task: 'Final photos and measurements - Compare!', completed: false }
        ]
    },
    'mindfulness-90': {
        id: 'mindfulness-90',
        name: 'üßò 90-Day Mindfulness Mastery',
        description: 'Build a sustainable meditation and mindfulness practice',
        duration: 90,
        tasks: [
            { day: 1, task: '5 min meditation - Focus on breath', completed: false },
            { day: 7, task: 'Journal feelings for 10 minutes every day', completed: false },
            { day: 30, task: 'Meditate for 15 minutes daily', completed: false },
            { day: 60, task: 'Perform a walking meditation', completed: false },
            { day: 90, task: 'Write a letter to your future self', completed: false }
        ]
    }
};

// Breathing configuration for the 4 modes
const BREATH_CONFIG = {
    coherence: { inhale: 5, holdIn: 0, exhale: 5, holdOut: 0 },
    box: { inhale: 4, holdIn: 4, exhale: 4, holdOut: 4 },
    calm: { inhale: 4, holdIn: 0, exhale: 6, holdOut: 0 },
    energy: { inhale: 2, holdIn: 0, exhale: 4, holdOut: 0 },
};
let audioCtx, oscillator, gainNode;
let running = false;
let startTime = 0;
let animId = null;
let currentConfig = BREATH_CONFIG.coherence;
const el = {
    circle: null, status: null, modeSelect: null, freqSelect: null, startBtn: null, stopBtn: null
};

// --- Helper functions ---
function $(id) { return document.getElementById(id); }
function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
function saveState() { localStorage.setItem('undo_state', JSON.stringify(state)); }

function loadState() {
  try {
    const savedState = JSON.parse(localStorage.getItem('undo_state'));
    if (savedState) {
      // Merge saved state to keep new default properties
      Object.assign(state, savedState);
      // Ensure new nested properties exist
      state.userData = state.userData || {};
      state.userData.email = state.userData.email || savedState.userData.email || '';
      state.isLoggedIn = state.isLoggedIn || false;
      state.quitHabits = state.quitHabits || [];
      state.buildHabits = state.buildHabits || [];
      state.chatHistory = state.chatHistory || [];
    }
  } catch (e) { console.error("Error loading state", e); }
}

function showNotification(message) {
  const notif = $('notification');
  notif.textContent = message;
  notif.classList.add('show');
  setTimeout(() => { notif.classList.remove('show'); }, 3000);
}

function calculateStreak(completions, dailyGoal) {
  let streak = 0;
  let currentDate = new Date();
  currentDate.setHours(0, 0, 0, 0);

  while (true) {
    const dateString = currentDate.toISOString().split('T')[0];
    const completionValue = completions[dateString] || 0;
    if (completionValue >= dailyGoal) {
      streak++;
      currentDate.setDate(currentDate.getDate() - 1);
    } else {
      break;
    }
  }
  return streak;
}

function formatDuration(seconds) {
  if (seconds < 60) return `${Math.floor(seconds)} seconds`;
  if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes`;
  if (seconds < 86400) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return `${hours} hours, ${minutes} minutes`;
  }
  const days = Math.floor(seconds / 86400);
  const hours = Math.floor((seconds % 86400) / 3600);
  return `${days} days, ${hours} hours`;
}

function toggleDarkMode() {
  const isDark = document.body.classList.toggle('dark');
  localStorage.setItem('undo_dark_mode', isDark ? 'dark' : 'light');
  $('btn-dark').setAttribute('aria-pressed', isDark);
  $('btn-dark').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  if ($('mobile-menu-dark-toggle')) $('mobile-menu-dark-toggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
}

function changePage(newPage) {
  if (state.page === newPage) return;
  state.page = newPage;
  const pages = ['dashboard', 'ai-coach', 'challenges', 'premium', 'breathing', 'analytics', 'settings'];
  pages.forEach(p => {
    const el = $(`${p}-page`);
    if (el) el.style.display = (p === newPage) ? 'block' : 'none';
  });

  document.querySelectorAll('[data-page]').forEach(el => {
    el.classList.toggle('active', el.dataset.page === newPage);
  });

  renderAll();
  saveState();
}

// --- Onboarding / User Auth Functions ---

function handleCredentialResponse(response) {
    if (response.credential) {
        showLoading('Signing you in...');
        // Mock token parsing (In a real app, this would be validated on the server)
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        
        state.userData.email = payload.email || 'N/A';

        if (!state.isLoggedIn) {
            // First time login or data cleared
            state.userData.name = payload.given_name || 'Friend';
            state.answers.name = state.userData.name;
            showLoading('Setting up your profile...');
            setTimeout(() => {
                $('welcome-loading').style.display = 'none';
                $('welcome-content').style.display = 'block';
                $('login-step').style.display = 'none';
                $('question-wrap').style.display = 'flex';
                state.questionIndex = 0;
                renderQuestion();
            }, 1000);
        } else {
            // Re-login, skip onboarding questions
            state.userData.name = payload.given_name || state.userData.name;
            state.isLoggedIn = true;
            saveState();
            setTimeout(() => { finishOnboarding(); }, 1000);
        }
    }
}

function showLoading(text) {
    $('welcome-content').style.display = 'none';
    $('welcome-loading').style.display = 'block';
    $('loading-text').textContent = text;
}

function renderQuestion() {
    const qData = QUESTIONS[state.questionIndex];
    if (!qData) return;

    $('q-text').innerHTML = qData.q;
    $('btn-back-question').style.display = state.questionIndex > 0 ? 'flex' : 'none';

    const inputWrap = $('q-input-wrap');
    inputWrap.innerHTML = '';

    if (qData.type === 'input') {
        const input = document.createElement(qData.inputType === 'textarea' ? 'textarea' : 'input');
        input.type = qData.inputType;
        input.id = 'current-question-input';
        input.placeholder = qData.default || '';
        input.value = state.answers[qData.key] || qData.default || '';
        inputWrap.appendChild(input);
    } else if (qData.type === 'select') {
        const select = document.createElement('select');
        select.id = 'current-question-input';
        qData.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            select.appendChild(option);
        });
        select.value = state.answers[qData.key] || qData.options[0].value;
        inputWrap.appendChild(select);
    }

    const dotbar = $('dotbar');
    dotbar.innerHTML = QUESTIONS.map((_, i) => 
        `<div class="dot ${i === state.questionIndex ? 'active' : ''}"></div>`
    ).join('');
}

function handleQuestionSubmit() {
    const qData = QUESTIONS[state.questionIndex];
    const inputEl = $('current-question-input');
    
    if (!inputEl.value.trim() && qData.inputType !== 'textarea') {
        showNotification("Please provide an answer to continue.");
        return;
    }

    state.answers[qData.key] = inputEl.value.trim();

    if (state.questionIndex < QUESTIONS.length - 1) {
        state.questionIndex++;
        renderQuestion();
    } else {
        processOnboardingAnswers();
    }
    saveState();
}

function processOnboardingAnswers() {
    // 1. Update User Data
    state.userData.name = state.answers.name || state.userData.name;
    state.userData.why = state.answers.why || state.userData.why;

    // 2. Create initial habits
    const quitCategory = state.answers.quitCategory;
    const buildCategory = state.answers.buildCategory;

    // Quit Habit
    if (quitCategory && quitCategory !== 'other') {
        state.quitHabits.push({
            id: uid(),
            name: ALL_CATEGORIES[quitCategory].label.split(' ')[0], // e.g., 'Smoking'
            category: quitCategory,
            type: 'quit',
            icon: ALL_CATEGORIES[quitCategory].label.split(' ')[1],
            lastTime: new Date().toISOString(),
            completions: {}, // Used for tracking relapses/logs
            relapseHistory: []
        });
    }

    // Build Habit
    if (buildCategory && buildCategory !== 'other') {
        state.buildHabits.push({
            id: uid(),
            name: ALL_CATEGORIES[buildCategory].label.split(' ')[0], // e.g., 'Exercise'
            category: buildCategory,
            type: 'build',
            icon: ALL_CATEGORIES[buildCategory].label.split(' ')[1],
            dailyGoal: 1,
            unit: 'times',
            completions: {},
            currentStreak: 0,
            bestStreak: 0
        });
    }

    // 3. Complete onboarding
    finishOnboarding();
}

function finishOnboarding() {
    state.isLoggedIn = true;
    state.screen = 'dashboard';
    state.page = 'dashboard';
    state.questionIndex = 0; // Reset for future use
    state.answers = {}; // Clear answers
    showNotification(`Welcome, ${state.userData.name}! Let's UNDO some bad habits.`);
    saveState();
    renderAll();
}

// --- Modal Functions (Add Habit) ---
let currentHabitToEdit = null;

function openAddModal(type, habit = null) {
    const modal = $('add-modal');
    currentHabitToEdit = habit;

    $('modal-title').textContent = habit ? `Edit ${habit.name}` : (type === 'quit' ? 'Add Quit Habit ‚ùå' : 'Add Build Habit ‚úÖ');

    const isQuit = type === 'quit';
    $('quit-fields').style.display = isQuit ? 'block' : 'none';
    $('build-fields').style.display = isQuit ? 'none' : 'block';

    // Populate Category Select
    const select = $('add-category');
    select.innerHTML = '';
    const filteredCategories = Object.entries(ALL_CATEGORIES).filter(([, v]) => v.type === type || v.type === 'both');
    filteredCategories.forEach(([key, value]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = value.label;
        select.appendChild(option);
    });

    if (habit) {
        $('add-name').value = habit.name;
        select.value = habit.category;
        
        if (isQuit) {
            $('add-startdate').value = habit.lastTime ? habit.lastTime.substring(0, 16) : new Date().toISOString().substring(0, 16);
        } else {
            $('add-daily-goal').value = habit.dailyGoal || 1;
            $('add-unit').value = habit.unit;
            $('add-custom-unit').value = habit.customUnit || '';
            $('custom-unit-wrap').style.display = (habit.unit === 'custom') ? 'block' : 'none';
        }
        $('add-save').textContent = 'Save Changes';
    } else {
        $('add-name').value = '';
        $('add-startdate').value = new Date().toISOString().substring(0, 16);
        $('add-daily-goal').value = 1;
        $('add-unit').value = 'times';
        $('add-custom-unit').value = '';
        $('custom-unit-wrap').style.display = 'none';
        $('add-save').textContent = 'Save Habit';
    }

    modal.classList.add('show');
}

function closeAddModal() {
    $('add-modal').classList.remove('show');
    currentHabitToEdit = null;
}

function handleSaveHabit() {
    const name = $('add-name').value.trim();
    const category = $('add-category').value;
    const categoryData = ALL_CATEGORIES[category] || { type: 'quit', label: 'Other/Custom üí°' };
    const type = categoryData.type === 'both' ? (currentHabitToEdit?.type || (currentHabitToEdit === null ? 'quit' : 'quit')) : categoryData.type; // Default to quit for 'other' if adding new
    const isQuit = type === 'quit';

    if (!name) {
        showNotification("Habit name is required.");
        return;
    }

    if (currentHabitToEdit) {
        // Edit Existing
        currentHabitToEdit.name = name;
        currentHabitToEdit.category = category;
        currentHabitToEdit.icon = categoryData.label.split(' ')[1];

        if (isQuit) {
            currentHabitToEdit.lastTime = $('add-startdate').value ? new Date($('add-startdate').value).toISOString() : new Date().toISOString();
        } else {
            currentHabitToEdit.dailyGoal = parseInt($('add-daily-goal').value) || 1;
            currentHabitToEdit.unit = $('add-unit').value;
            currentHabitToEdit.customUnit = $('add-custom-unit').value;
        }
        showNotification(`${name} updated.`);
    } else {
        // Add New
        const newHabit = {
            id: uid(),
            name: name,
            category: category,
            type: type,
            icon: categoryData.label.split(' ')[1] || 'üí°',
            completions: {},
            relapseHistory: []
        };

        if (isQuit) {
            newHabit.lastTime = $('add-startdate').value ? new Date($('add-startdate').value).toISOString() : new Date().toISOString();
        } else {
            newHabit.dailyGoal = parseInt($('add-daily-goal').value) || 1;
            newHabit.unit = $('add-unit').value;
            newHabit.customUnit = $('add-custom-unit').value;
            newHabit.currentStreak = 0;
            newHabit.bestStreak = 0;
        }

        if (type === 'quit') {
            state.quitHabits.push(newHabit);
        } else {
            state.buildHabits.push(newHabit);
        }
        showNotification(`${name} added!`);
    }

    closeAddModal();
    saveState();
    renderAll();
}

// --- Modal Functions (Relapse) ---
let habitToRelapse = null;

function openRelapseModal(habit) {
    if (habit.type !== 'quit') return; // Should not happen but good check
    habitToRelapse = habit;
    $('relapse-habit-name').textContent = habit.name;
    $('relapse-time').value = new Date().toISOString().substring(0, 16);
    $('relapse-reason').value = '';
    $('relapse-modal').classList.add('show');
}

function closeRelapseModal() {
    $('relapse-modal').classList.remove('show');
    habitToRelapse = null;
}

function handleRelapseConfirm() {
    if (!habitToRelapse) return;

    const relapseTime = $('relapse-time').value ? new Date($('relapse-time').value) : new Date();
    const relapseReason = $('relapse-reason').value.trim();

    // 1. Reset streak (set new lastTime)
    habitToRelapse.lastTime = relapseTime.toISOString();

    // 2. Log relapse
    habitToRelapse.relapseHistory.push({
        time: relapseTime.toISOString(),
        reason: relapseReason,
        streakLost: formatDuration((new Date() - new Date(habitToRelapse.lastTime)) / 1000) // The old streak length is calculated before the reset
    });

    closeRelapseModal();
    saveState();
    renderAll();
    showNotification(`Streak reset for ${habitToRelapse.name}. Let's get back on track!`);
}

// --- Emergency Mode Functions ---
let emergencyIntervalId = null;
let emergencyCoachIndex = 0;

function openEmergencyModal(habit) {
    state.emergencyHabit = habit;
    $('emergency-overlay').classList.add('show');
    
    // Attempt to start camera (placeholder logic)
    const video = $('emergency-video');
    const fallback = $('camera-fallback');
    
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
            .then(stream => {
                video.srcObject = stream;
                video.style.display = 'block';
                fallback.style.display = 'none';
            })
            .catch(error => {
                console.error("Camera access denied or failed:", error);
                video.style.display = 'none';
                fallback.style.display = 'flex';
            });
    } else {
        video.style.display = 'none';
        fallback.style.display = 'flex';
    }

    // Start coach lines
    emergencyCoachIndex = 0;
    startCoachTyping();
    emergencyIntervalId = setInterval(startCoachTyping, 6000); // Change line every 6 seconds
}

function closeEmergencyModal() {
    $('emergency-overlay').classList.remove('show');
    state.emergencyHabit = null;
    
    // Stop camera
    const video = $('emergency-video');
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }

    // Stop coach lines
    if (emergencyIntervalId) {
        clearInterval(emergencyIntervalId);
        emergencyIntervalId = null;
    }
}

function startCoachTyping() {
    stopCoachTyping();
    const lineEl = $('coach-line');
    if (!lineEl) return;

    const line = COACH_LINES[emergencyCoachIndex % COACH_LINES.length];
    lineEl.textContent = '';
    
    let i = 0;
    const typingSpeed = 50; 
    
    const type = () => {
        if (i < line.length) {
            lineEl.textContent += line.charAt(i);
            i++;
            setTimeout(type, typingSpeed);
        }
    }
    type();
    emergencyCoachIndex++;
}

function stopCoachTyping() {
    // Stops the typing animation (by stopping the recursive timeout)
    // Note: The main interval still runs to call startCoachTyping()
}

// Emergency button handlers
document.addEventListener('DOMContentLoaded', () => {
    $('emergency-done')?.addEventListener('click', closeEmergencyModal);
    $('emergency-relapse')?.addEventListener('click', () => {
        if (state.emergencyHabit) {
            openRelapseModal(state.emergencyHabit);
            closeEmergencyModal();
        }
    });
});

// --- Breathing Logic ---

function initTone() {
    try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        gainNode = audioCtx.createGain();
        gainNode.connect(audioCtx.destination);
    } catch (e) {
        console.warn("Audio not supported or failed to initialize:", e);
    }
}

function startTone(frequency) {
    if (frequency === 'off' || !audioCtx) return;

    if (oscillator) {
        oscillator.stop();
        oscillator.disconnect();
    }

    oscillator = audioCtx.createOscillator();
    oscillator.type = 'sine'; 
    oscillator.frequency.setValueAtTime(parseFloat(frequency), audioCtx.currentTime); 
    
    oscillator.connect(gainNode);
    gainNode.gain.setValueAtTime(0.0, audioCtx.currentTime); // Start silent
    oscillator.start();
}

function stopTone() {
    if (oscillator) {
        oscillator.stop();
        oscillator.disconnect();
        oscillator = null;
    }
}

function animate(timestamp) {
  if (!startTime) startTime = timestamp;
  const elapsed = timestamp - startTime;
  
  const IN = currentConfig.inhale * 1000;
  const HI = currentConfig.holdIn * 1000;
  const EX = currentConfig.exhale * 1000;
  const HO = currentConfig.holdOut * 1000;
  const cycleMs = IN + HI + EX + HO;
  const pos = elapsed % cycleMs;

  let phase='INHALE ‚¨ÜÔ∏è', scale=0.3;
  let targetGain = 0.0;
  const gainDuration = 0.5; // Smooth audio change over 0.5s

  if(pos < IN){
    phase='INHALE ‚¨ÜÔ∏è';
    scale = 0.3 + 0.7 * (pos/IN);
    targetGain = 0.2; // Gain on inhale
  } else if(pos < IN + HI){
    phase='HOLD ‚è∏';
    scale = 1.0;
  } else if(pos < IN + HI + EX){
    phase='EXHALE ‚¨áÔ∏è';
    scale = 1.0 - 0.7 * ((pos-IN-HI)/EX);
    targetGain = 0.05; // Quiet gain on exhale
  } else {
    phase='HOLD ‚è∏';
    scale = 0.3;
  }

  el.circle.style.transform = `scale(${scale})`;
  if(el.status) el.status.textContent = phase;
  if(gainNode) gainNode.gain.linearRampToValueAtTime(targetGain, audioCtx.currentTime + gainDuration);

  animId = requestAnimationFrame(animate);
}

function startSession(){
    if(running) stopSession();
    
    // Initialize elements if not done
    el.circle = $('breathingCircle');
    el.status = $('breathingStatus');
    el.modeSelect = $('breath-mode');
    el.freqSelect = $('breath-freq');
    el.startBtn = $('start-breathing');
    el.stopBtn = $('stop-breathing');

    if (!el.circle || !el.status) return;

    const key = el.modeSelect.value || 'coherence';
    currentConfig = BREATH_CONFIG[key];
    
    el.startBtn.style.display='none'; 
    el.stopBtn.style.display='';
    
    initTone();
    startTone(el.freqSelect.value);

    running = true; 
    startTime = 0; 
    animId = requestAnimationFrame(animate);
    el.circle.classList.add('glowing');
}

function stopSession(){
    running = false; 
    if(animId) cancelAnimationFrame(animId);
    stopTone();
    if (el.status) el.status.textContent = 'INHALE ‚¨ÜÔ∏è';
    if (el.circle) el.circle.style.transform = 'scale(0.3)';
    if (el.circle) el.circle.classList.remove('glowing');

    // Reset button visibility if elements are available
    if (el.startBtn) el.startBtn.style.display = '';
    if (el.stopBtn) el.stopBtn.style.display = 'none';
}

// --- End of Breathing Logic ---


let isAILoading = false;

// Function to handle sending a message to the AI coach
async function handleChatMessage(message) {
    if (!state.isPremium) {
        changePage('premium');
        return "I can't answer that. The AI Coach is a Premium feature. Upgrade now! üëë";
    }

    if (isAILoading) return;
    isAILoading = true;
    
    // Clear input and append user message
    const input = $('chat-input');
    if (input) input.value = '';
    
    renderChatMessage('user', message);
    const typingIndicator = renderTypingIndicator();
    scrollToChatBottom();

    const quitHabitNames = state.quitHabits.map(h => h.name + ' (Streak: ' + calculateStreak(h.completions, 1) + ' days)').join('; ') || 'None yet';
    const buildHabitNames = state.buildHabits.map(h => h.name + ' (Goal: ' + h.dailyGoal + ' ' + h.unit + ')').join('; ') || 'None yet';

    // CALCULATE SYSTEM PROMPT ON CLIENT TO PASS HABIT DATA TO SERVER
    const systemPrompt = `You are a supportive, no-nonsense habit coach named 'UNDO AI'. Your user's name is ${state.userData.name}. You are here to help them stick to their goals and recover from setbacks. Quit Habits: ${quitHabitNames} - Build Habits: ${buildHabitNames} - Motivation: ${state.userData.why || 'Not specified'} Be supportive, evidence-based, and actionable. Keep responses concise, under 150 words. Use emojis sparingly.`;
    
    // START: NEW SECURE FETCH TO RAILWAY ENDPOINT
    try {
        const response = await fetch('/api/ai-coach', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prompt: message, // Current user message
                system: systemPrompt, // Dynamic system prompt with user data
                history: state.chatHistory.slice(-10) // Last 10 messages for context
            })
        });

        if (!response.ok) {
            // Check for server-side errors
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();
        const aiResponse = data.choices[0].message.content;
        // END: NEW SECURE FETCH

        // Remove typing indicator and render AI response
        typingIndicator.remove();
        renderChatMessage('assistant', aiResponse);
        scrollToChatBottom();

        // Add messages to history only after successful API call
        state.chatHistory.push({ role: 'user', content: message });
        state.chatHistory.push({ role: 'assistant', content: aiResponse });
        if (state.chatHistory.length > 20) {
            state.chatHistory = state.chatHistory.slice(-20);
        }
        saveState();
        return aiResponse;
    } catch (error) {
        console.error('AI Error:', error);
        typingIndicator.remove();
        const errorMessage = "I'm having trouble connecting right now. Please try again in a moment. üí≠";
        renderChatMessage('assistant', errorMessage);
        scrollToChatBottom();
        return errorMessage;
    } finally {
        isAILoading = false;
        if ($('chat-input')) $('chat-input').focus();
    }
}

function renderChatMessage(role, content) {
  const messagesContainer = $('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${role}`;
  
  // Auto-link URLs
  const processedContent = content.replace(/(https?:\/\/[^\s]+)/g, (url) => {
    return `<a href="${url}" target="_blank" style="color:white;text-decoration:underline;">${url}</a>`;
  });

  messageDiv.innerHTML = `
    <div class="chat-avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
    <div class="chat-bubble">${processedContent}</div>
  `;
  messagesContainer.appendChild(messageDiv);
}

function renderTypingIndicator() {
  const messagesContainer = $('chat-messages');
  const typingDiv = document.createElement('div');
  typingDiv.className = 'chat-message assistant typing-indicator-wrap';
  typingDiv.innerHTML = `
    <div class="chat-avatar">ü§ñ</div>
    <div class="typing-indicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  `;
  messagesContainer.appendChild(typingDiv);
  return typingDiv;
}

function scrollToChatBottom() {
  const messagesContainer = $('chat-messages');
  if (messagesContainer) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
}

// --- Render Functions ---
function renderHabit(habit) {
    const isQuit = habit.type === 'quit';
    const card = document.createElement('div');
    card.className = 'habit-card';

    // Calculate Streak/Timer
    let primaryStat = '';
    let secondaryStat = '';
    const now = new Date();

    if (isQuit) {
        const lastTime = new Date(habit.lastTime);
        const diffSeconds = Math.floor((now - lastTime) / 1000);
        const days = Math.floor(diffSeconds / 86400);
        const hours = Math.floor((diffSeconds % 86400) / 3600);
        const minutes = Math.floor((diffSeconds % 3600) / 60);

        primaryStat = `<div style="font-size:1.75rem;font-weight:900;color:var(--green-from)">${days}</div> <div class="small muted">days clean</div>`;
        secondaryStat = `<div class="small muted">Since: ${lastTime.toLocaleDateString()} ${lastTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
    } else {
        const dailyGoal = habit.dailyGoal || 1;
        const todayString = now.toISOString().split('T')[0];
        const completedToday = habit.completions[todayString] || 0;
        const streak = calculateStreak(habit.completions, dailyGoal);

        primaryStat = `<div style="font-size:1.75rem;font-weight:900;color:var(--green-from)">${streak}</div> <div class="small muted">day streak</div>`;
        secondaryStat = `<div class="small muted">${completedToday} / ${dailyGoal} ${habit.unit} today</div>`;
    }

    let progressButton = '';
    if (isQuit) {
        progressButton = `
            <button class="btn btn-danger btn-wide open-emergency" data-habit-id="${habit.id}">
                üö® Emergency Button
            </button>
            <button class="btn btn-ghost btn-wide open-relapse" data-habit-id="${habit.id}" style="margin-top:0.5rem">
                I Relapsed
            </button>
        `;
    } else {
        progressButton = `
            <div class="flex gap-4">
                <button class="btn btn-ghost btn-wide update-progress" data-action="minus" data-habit-id="${habit.id}">-</button>
                <button class="btn btn-success btn-wide update-progress" data-action="plus" data-habit-id="${habit.id}">
                    ${habit.unit === 'times' ? 'Done' : `+ ${habit.dailyGoal} ${habit.unit}`}
                </button>
            </div>
        `;
    }

    card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
            <div class="section-title">
                <div style="font-size:1.5rem">${habit.icon}</div>
                <div>
                    <div class="heading" style="font-size:1.25rem">${habit.name}</div>
                    <div class="small muted">${ALL_CATEGORIES[habit.category]?.label || 'Custom'}</div>
                </div>
            </div>
            <button class="btn btn-ghost small edit-habit" data-habit-id="${habit.id}">‚öôÔ∏è</button>
        </div>

        <div class="green-panel" style="margin-bottom:1rem">
            ${primaryStat}
        </div>
        ${secondaryStat}
        <div style="margin-top:1rem">
            ${progressButton}
        </div>
    `;

    return card;
}

function renderQuitList() {
    const listEl = $('quit-list');
    listEl.innerHTML = '';
    if (state.quitHabits.length === 0) {
        listEl.innerHTML = '<div class="empty">No Quit Habits added yet.</div>';
    }
    state.quitHabits.forEach(h => listEl.appendChild(renderHabit(h)));
}

function renderBuildList() {
    const listEl = $('build-list');
    listEl.innerHTML = '';
    if (state.buildHabits.length === 0) {
        listEl.innerHTML = '<div class="empty">No Build Habits added yet.</div>';
    }
    state.buildHabits.forEach(h => listEl.appendChild(renderHabit(h)));
}

function renderChatPage() {
    const messagesContainer = $('chat-messages');
    messagesContainer.innerHTML = ''; // Clear existing
    
    // Initial AI message
    renderChatMessage('assistant', "Hi! I'm your AI coach powered by GPT-4. I'm here to support you on your journey. How can I help you today?");

    // Render history
    state.chatHistory.forEach(msg => renderChatMessage(msg.role, msg.content));
    scrollToChatBottom();
}

function renderAll() {
    // 1. General UI Updates
    $('main-header').style.display = state.isLoggedIn ? 'block' : 'none';
    $('welcome').style.display = state.isLoggedIn ? 'none' : 'flex';
    $('app-main').style.display = state.isLoggedIn ? 'block' : 'none';
    $('greeting').textContent = `Hey ${state.userData.name}!`;

    // 2. Mobile Menu
    document.querySelectorAll('.mobile-menu-item').forEach(el => {
        el.classList.toggle('active', el.dataset.page === state.page);
    });
    $('mobile-menu-name').textContent = state.userData.name;
    $('mobile-menu-email').textContent = state.userData.email || 'Not Logged In';

    // 3. Premium UI Updates
    updatePremiumUI();

    // 4. Dashboard & Habit Lists
    $('quit-count').textContent = state.quitHabits.length;
    $('build-count').textContent = state.buildHabits.length;
    renderQuitList();
    renderBuildList();

    // 5. Page-Specific Renders
    if (state.page === 'ai-coach') renderChatPage();
    if (state.page === 'challenges') renderChallenges();
    if (state.page === 'analytics') renderAnalytics();
    if (state.page === 'settings') renderSettings();
    if (state.page === 'breathing') stopSession(); // Ensure breathing is stopped when navigating away
}

function updatePremiumUI() {
    state.isPremium = localStorage.getItem('undo_premium') === 'true';
    const isFreeLimitReached = state.quitHabits.length + state.buildHabits.length >= 3;

    // Premium Badge (Header and Mobile)
    const premiumBadgeElements = ['premium-badge-header', 'mobile-menu-premium'];
    premiumBadgeElements.forEach(id => {
        const el = $(id);
        if (el) el.style.display = state.isPremium ? 'inline-flex' : 'none';
    });
    // Premium Button
    $('btn-premium').style.display = state.isPremium ? 'none' : 'inline-flex';

    // Premium Check: AI Coach & Challenges
    const premiumPages = ['ai-coach', 'challenges', 'analytics'];
    premiumPages.forEach(p => {
        const pageEl = $(`${p}-page`);
        if (pageEl) {
            const overlay = pageEl.querySelector('.premium-overlay');
            if (!state.isPremium && p !== 'premium') {
                if (!overlay) {
                     pageEl.insertAdjacentHTML('afterbegin', `
                        <div class="premium-overlay" style="position:relative;margin-bottom:1.5rem;padding:2rem;">
                            <div style="text-align:center; color:white;">
                                <div style="font-size:3rem;margin-bottom:1rem">üëë</div>
                                <h3 class="heading" style="font-size:1.75rem;margin-bottom:0.5rem">Upgrade to Premium</h3>
                                <p style="opacity:0.9; margin-bottom:1.5rem;">Unlock the ${p.split('-').map(s=>s.charAt(0).toUpperCase() + s.slice(1)).join(' ')} feature and much more!</p>
                                <button onclick="changePage('premium')" class="btn btn-gold" style="font-size:1.125rem; padding:1rem;"> Go Premium </button>
                            </div>
                        </div>
                    `);
                }
            } else if (overlay) {
                overlay.remove();
            }
        }
    });

    // Premium Check: Habit Limit Banner
    $('habit-limit-banner').style.display = !state.isPremium && isFreeLimitReached ? 'block' : 'none';

    // Disable adding new habits if limit reached on free plan
    const addButtons = [$('add-quit'), $('add-build')];
    addButtons.forEach(btn => {
        if (btn) btn.disabled = !state.isPremium && isFreeLimitReached;
        if (btn && !state.isPremium && isFreeLimitReached) {
            btn.title = "Free plan limit reached (3 habits).";
        } else if (btn) {
            btn.title = '';
        }
    });
}

function renderAnalytics() {
    if (!state.isPremium) {
        // Overlay handles this, but prevent processing if free user
        $('analyticsMain').style.display = 'none';
        return;
    }
    $('analyticsMain').style.display = 'block';

    // KPI Row (Mock Data)
    $('kpiRow').innerHTML = `
        <div class="kpi">
            <div class="small muted">Total Days Tracking</div>
            <div class="num">${Math.floor(Math.random() * 100) + 30}</div>
        </div>
        <div class="kpi">
            <div class="small muted">Best Quit Streak</div>
            <div class="num">${state.quitHabits.reduce((max, h) => Math.max(max, Math.floor((new Date() - new Date(h.lastTime)) / 86400000)), 0)} days</div>
        </div>
        <div class="kpi">
            <div class="small muted">Highest Build Streak</div>
            <div class="num">${state.buildHabits.reduce((max, h) => Math.max(max, h.bestStreak || 0), 0)} days</div>
        </div>
        <div class="kpi">
            <div class="small muted">Relapses / Slips</div>
            <div class="num">${state.quitHabits.reduce((sum, h) => sum + (h.relapseHistory?.length || 0), 0)}</div>
        </div>
    `;

    // Chart Data (Mock Implementation)
    if (!state.analyticsChart) {
        const ctx7 = $('chart7').getContext('2d');
        state.analyticsChart = new Chart(ctx7, {
            type: 'line',
            data: {
                labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
                datasets: [{
                    label: 'Success Rate (%)',
                    data: [50, 70, 60, 80, 75, 90, 95],
                    borderColor: '#7c3aed',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    } else {
        // Update chart data if needed
    }
}

// --- Challenges Logic --- (Placeholder logic)
function renderChallenges() {
    const container = $('challenges-container');
    container.innerHTML = '';
    Object.values(CHALLENGE_PACKS).forEach(challenge => {
        const isActive = state.activeChallenge === challenge.id;
        const card = document.createElement('div');
        
        let progressPercent = 0;
        let daysPassed = 0;

        if (isActive && state.userData.challengeStart) {
            const start = new Date(state.userData.challengeStart);
            daysPassed = Math.min(challenge.duration, Math.floor((new Date() - start) / 86400000) + 1);
            
            const totalTasks = challenge.tasks.length;
            const completedTasks = challenge.tasks.filter(t => t.completed).length;
            progressPercent = Math.min(100, (completedTasks / totalTasks) * 100);
        }

        const completedTasks = challenge.tasks.filter(t => t.completed).length;
        const totalTasks = challenge.tasks.length;
        
        let buttonText = isActive ? 'Stop Challenge' : 'Start Challenge';
        let buttonClass = isActive ? 'btn-danger' : 'btn-primary';

        card.innerHTML = `
            <div class="challenge-card ${isActive ? 'active' : ''}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start">
                    <div>
                        <div class="heading" style="font-size:1.5rem;margin-bottom:0.25rem">${challenge.name}</div>
                        <div class="small muted">${challenge.description}</div>
                    </div>
                    <div class="small muted" style="font-weight:600;text-align:right">
                        ${challenge.duration} Days
                    </div>
                </div>

                ${isActive ? `
                    <div class="challenge-progress">
                        <div class="challenge-progress-bar" style="width:${progressPercent}%"></div>
                    </div>
                    <div class="small muted" style="display:flex;justify-content:space-between;font-weight:600;margin-bottom:1rem">
                        <span>Day ${daysPassed} / ${challenge.duration}</span>
                        <span>${completedTasks}/${totalTasks} Tasks</span>
                    </div>
                    <div id="challenge-tasks-${challenge.id}">
                        ${challenge.tasks.map(t => `
                            <div class="task-item ${t.completed ? 'completed' : ''}">
                                <input type="checkbox" class="task-checkbox" onchange="toggleTask('${challenge.id}', '${t.task.replace(/'/g, "\\'")}')" ${t.completed ? 'checked' : ''} />
                                <span style="flex:1;text-align:left;">
                                    <span style="font-weight:600">${t.day}-Day Task:</span> ${t.task}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                ` : `<div style="padding:1rem 0;text-align:center" class="small muted">Click to see tasks</div>`}

                <button class="btn ${buttonClass} btn-wide" style="margin-top:1rem" onclick="handleChallengeAction('${challenge.id}', ${isActive})">
                    ${buttonText}
                </button>
            </div>
        `;

        container.appendChild(card);
    });
}

function handleChallengeAction(id, isActive) {
    if (isActive) {
        if (confirm("Are you sure you want to end this challenge?")) {
            state.activeChallenge = null;
            state.userData.challengeStart = null;
            saveState();
            showNotification("Challenge ended.");
            renderAll();
        }
    } else {
        if (!state.isPremium) {
            showNotification("Challenges are a Premium feature. Please upgrade to start.");
            changePage('premium');
            return;
        }
        if (state.activeChallenge) {
            showNotification("You can only have one active challenge at a time. End your current one first.");
            return;
        }
        const challenge = CHALLENGE_PACKS[id];
        if (confirm(`Start the üéØ ${challenge.name} challenge?`)) {
            state.activeChallenge = id;
            state.userData.challengeStart = new Date().toISOString();
            // Reset tasks in the challenge definition for the new start
            challenge.tasks.forEach(t => t.completed = false);
            saveState();
            showNotification(`${challenge.name} started! Good luck!`);
            renderAll();
        }
    }
}

function toggleTask(challengeId, taskText) {
    if (!state.activeChallenge || state.activeChallenge !== challengeId) return;
    const challenge = CHALLENGE_PACKS[challengeId];
    if (challenge) {
        const task = challenge.tasks.find(t => t.task === taskText);
        if (task) {
            task.completed = !task.completed;
            saveState();
            renderAll(); // Re-render to update UI
            showNotification(task.completed ? 'Task completed! ‚úÖ' : 'Task undone.');
        }
    }
}

function renderSettings() {
    $('setting-name').value = state.userData.name;
    $('setting-email').value = state.userData.email;
    $('setting-why').value = state.userData.why;
}

function saveProfileSettings() {
    state.userData.name = $('setting-name').value;
    state.userData.why = $('setting-why').value;
    saveState();
    showNotification("Profile updated! üëç");
    renderAll();
}

function exportAllData() {
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `undo_data_export_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification("Data exported successfully!");
}

function importAllData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedState = JSON.parse(e.target.result);
            if (importedState && importedState.quitHabits && importedState.buildHabits) {
                // Merge imported data over current state (excluding transient things like screen/page)
                Object.assign(state, { 
                    ...importedState, 
                    screen: state.isLoggedIn ? 'dashboard' : 'welcome', 
                    page: 'dashboard', 
                    questionIndex: 0, 
                    answers: {}, 
                    chatHistory: importedState.chatHistory || [] 
                });
                // Re-establish login status and email from the imported data, or keep current login if more recent
                state.isLoggedIn = state.isLoggedIn || importedState.isLoggedIn || false;
                if (importedState.userData && importedState.userData.email) {
                    state.userData.email = importedState.userData.email;
                }
                localStorage.setItem('undo_premium', state.isPremium);
                saveState();
                showNotification("Data import successful! Reloading dashboard...");
                renderAll();
            } else {
                throw new Error("Invalid UNDO data structure.");
            }
        } catch (error) {
            console.error("Import error:", error);
            showNotification(`Data import failed: ${error.message}`);
        }
    };
    reader.readAsText(file);
}

function resetAllData() {
    if (confirm("Are you absolutely sure you want to clear ALL your local data? This action is permanent.")) {
        localStorage.removeItem('undo_state');
        localStorage.removeItem('undo_premium');
        localStorage.removeItem('undo_dark_mode');
        // Force reload to clear all in-memory state
        window.location.reload();
    }
}

function logout() {
    // Clear login flag but keep user data (habits) in local storage
    state.isLoggedIn = false;
    saveState();
    // Attempt to sign out of Google (Google Sign-In usually requires specific library calls, but simply showing the sign-in screen again is enough for this single-file app)
    showNotification("You have been logged out.");
    window.location.reload();
}

// --- Initialization ---
function init() {
    // Load persisted state and dark mode setting
    loadState();
    if (localStorage.getItem('undo_dark_mode') === 'dark') {
        document.body.classList.add('dark');
        $('btn-dark').textContent = 'üåô';
        $('btn-dark').setAttribute('aria-pressed', true);
    } else {
        $('btn-dark').textContent = '‚òÄÔ∏è';
        $('btn-dark').setAttribute('aria-pressed', false);
    }

    // Set up Google Login
    if (!state.isLoggedIn) {
        // Only if we haven't logged in successfully before
        const gOnload = document.getElementById('g_id_onload');
        if (gOnload) gOnload.setAttribute('data-client_id', GOOGLE_CLIENT_ID);
    } else {
        // If logged in, skip welcome screen and go to dashboard
        showLoading('Loading your data...');
        setTimeout(() => { finishOnboarding(); }, 1000);
    }

    // Initial render for event listeners to be attached correctly
    renderAll();
}

// Attach all event listeners
document.addEventListener('DOMContentLoaded', () => {
    init();

    // Onboarding Buttons
    $('btn-next-question').addEventListener('click', handleQuestionSubmit);
    $('btn-back-question').addEventListener('click', () => {
        if (state.questionIndex > 0) {
            state.questionIndex--;
            renderQuestion();
            saveState();
        }
    });

    // Navigation Buttons
    document.querySelectorAll('[id^="btn-"]').forEach(btn => {
        if (btn.id.startsWith('btn-') && btn.id !== 'btn-next-question' && btn.id !== 'btn-back-question' && btn.id !== 'btn-burger' && btn.id !== 'btn-dark' && btn.id !== 'btn-logout') {
            btn.addEventListener('click', () => {
                const page = btn.id.replace('btn-', '');
                if (page === 'home') {
                    changePage('dashboard');
                } else {
                    changePage(page);
                }
            });
        }
    });
    document.querySelectorAll('.mobile-menu-item').forEach(btn => {
        btn.addEventListener('click', () => {
            changePage(btn.dataset.page);
            $('mobile-menu-overlay').classList.remove('show');
        });
    });

    // Add Habit Buttons
    $('add-quit').addEventListener('click', () => openAddModal('quit'));
    $('add-build').addEventListener('click', () => openAddModal('build'));
    $('add-cancel').addEventListener('click', closeAddModal);
    $('add-save').addEventListener('click', handleSaveHabit);
    $('add-unit').addEventListener('change', () => {
        $('custom-unit-wrap').style.display = ($('add-unit').value === 'custom') ? 'block' : 'none';
    });

    // Relapse Modal Buttons
    $('relapse-cancel').addEventListener('click', closeRelapseModal);
    $('relapse-confirm').addEventListener('click', handleRelapseConfirm);

    // Dynamic Habit List Buttons (using event delegation on main element)
    document.querySelector('main.wrap').addEventListener('click', (e) => {
        if (e.target.classList.contains('open-relapse')) {
            const habit = [...state.quitHabits, ...state.buildHabits].find(h => h.id === e.target.dataset.habitId);
            if (habit) openRelapseModal(habit);
        } else if (e.target.classList.contains('open-emergency')) {
            const habit = state.quitHabits.find(h => h.id === e.target.dataset.habitId);
            if (habit) openEmergencyModal(habit);
        } else if (e.target.classList.contains('edit-habit')) {
            const habit = [...state.quitHabits, ...state.buildHabits].find(h => h.id === e.target.dataset.habitId);
            if (habit) openAddModal(habit.type, habit);
        } else if (e.target.classList.contains('delete-habit')) {
            const habitId = e.target.dataset.habitId;
            if (confirm("Are you sure you want to delete this habit? This cannot be undone.")) {
                state.quitHabits = state.quitHabits.filter(h => h.id !== habitId);
                state.buildHabits = state.buildHabits.filter(h => h.id !== habitId);
                saveState();
                renderAll();
                showNotification("Habit deleted.");
            }
        } else if (e.target.classList.contains('update-progress')) {
            const habitId = e.target.dataset.habitId;
            const action = e.target.dataset.action;
            const habit = state.buildHabits.find(h => h.id === habitId);
            if (habit) {
                const now = new Date();
                const todayString = now.toISOString().split('T')[0];
                const amount = habit.dailyGoal || 1;
                let current = habit.completions[todayString] || 0;

                if (action === 'plus') {
                    current += amount;
                } else if (action === 'minus') {
                    current = Math.max(0, current - amount);
                }

                habit.completions[todayString] = current;
                
                // Update streak logic
                habit.currentStreak = calculateStreak(habit.completions, habit.dailyGoal);
                habit.bestStreak = Math.max(habit.bestStreak || 0, habit.currentStreak);

                saveState();
                renderAll();
                if (action === 'plus') showNotification(`Progress recorded for ${habit.name}!`);
            }
        }
    });

    // Premium button on dashboard banner
    if ($('upgrade-from-banner')) $('upgrade-from-banner').addEventListener('click', () => changePage('premium'));

    // Mobile Menu
    $('btn-burger').addEventListener('click', () => $('mobile-menu-overlay').classList.add('show'));
    $('mobile-menu-overlay').addEventListener('click', (e) => {
        if (e.target === $('mobile-menu-overlay')) $('mobile-menu-overlay').classList.remove('show');
    });

    // AI Coach
    $('chat-send').addEventListener('click', () => {
        const input = $('chat-input');
        if (input.value.trim()) handleChatMessage(input.value.trim());
    });
    $('chat-input').addEventListener('keypress', (e) => { 
        if (e.key === 'Enter') handleChatMessage(e.target.value); 
    });
    document.addEventListener('click', (e) => { 
        if (e.target.classList.contains('quick-question-btn')) handleChatMessage(e.target.dataset.question); 
    });
    
    // Breathing
    if ($('start-breathing')) $('start-breathing').addEventListener('click', startSession);
    if ($('stop-breathing')) $('stop-breathing').addEventListener('click', stopSession);
    
    // Settings
    if ($('btn-dark')) $('btn-dark').addEventListener('click', toggleDarkMode);
    if ($('mobile-menu-dark-toggle')) $('mobile-menu-dark-toggle').addEventListener('click', toggleDarkMode);
    if ($('save-profile')) $('save-profile').addEventListener('click', saveProfileSettings);
    if ($('export-data-btn')) $('export-data-btn').addEventListener('click', exportAllData);
    if ($('import-data-file')) $('import-data-file').addEventListener('change', importAllData);
    if ($('import-data-btn')) $('import-data-btn').addEventListener('click', () => $('import-data-file').click());
    if ($('reset-data-btn')) $('reset-data-btn').addEventListener('click', resetAllData);
    if ($('btn-logout')) $('btn-logout').addEventListener('click', logout);
    if ($('mobile-menu-logout')) $('mobile-menu-logout').addEventListener('click', logout);
    
    // Initial check for dark mode button content
    if (localStorage.getItem('undo_dark_mode') === 'dark') {
        $('btn-dark').textContent = 'üåô';
    } else {
        $('btn-dark').textContent = '‚òÄÔ∏è';
    }
});
</script>
</body>
</html>
