<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>UNDO ‚Äì Habit Tracker</title>
<meta name="description" content="UNDO - Quit Bad, Build Good. Track and improve your habits with AI coaching."/>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#7c3aed">
<link rel="apple-touch-icon" href="/icon-192.png">

<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  :root {
    --bg:#f8fafc;
    --card:#ffffff;
    --text:#0f1724;
    --muted:#6b7280;
    --border:#e6e7ea;
    --accent-from:#7c3aed;
    --accent-to:#ec4899;
    --green-from:#10b981;
    --green-to:#059669;
    --danger:#ef4444;
    --gold:#fbbf24;
    --radius: 16px;
    --shadow: 0 10px 30px rgba(2,6,23,0.06);
  }

  .dark {
    --bg:#0b1220;
    --card:#0f1724;
    --text:#ffffff;
    --muted:#94a3b8;
    --border:#22303b;
    --shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html { height: 100%; font-size: 16px; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    line-height: 1.5;
    min-height: 100vh;
    transition: background-color 0.5s, color 0.3s;
  }

  .wrap { max-width: 1200px; margin: 0 auto; padding: 1rem; }
  .card { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); transition: all 0.3s; }
  h1,h2,h3 { margin:0; font-weight:800; }
  .muted { color: var(--muted); }
  .small { font-size:0.875rem; }
  .heading { font-weight:800; }

  .btn {
    cursor:pointer;border:0;padding:0.75rem 1rem;border-radius:calc(var(--radius)-4px);
    font-weight:600;font-size:0.9375rem;display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;transition:all 0.2s;
  }
  .btn:active { transform: scale(0.98); }
  .btn-primary { background: linear-gradient(135deg,var(--accent-from),var(--accent-to)); color:white; }
  .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn-danger { background:var(--danger); color:white; }
  .btn-success { background: linear-gradient(135deg,var(--green-from),var(--green-to)); color:white; }
  .btn-gold { background: linear-gradient(135deg,#fbbf24,#f59e0b); color:#78350f; font-weight:700; }
  .btn-wide { width:100%; }
  .btn:disabled { opacity:0.5; cursor:not-allowed; }

  .premium-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    background: linear-gradient(135deg,#fbbf24,#f59e0b);
    color: #78350f;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 700;
    margin-left: 0.5rem;
  }

  input, select, textarea {
    width:100%; padding:0.75rem 1rem; border-radius:calc(var(--radius)-4px); border:2px solid var(--border);
    background:var(--card); color:var(--text); font-size:1rem; transition:border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus { outline:none; border-color:var(--accent-from); }
  textarea { min-height:100px; resize:vertical; }

  .flex { display:flex; }
  .grid { display:grid; }
  .gap-4 { gap:1rem; }
  .mb-4 { margin-bottom:1rem; }

  .dotbar { display:flex; gap:0.5rem; justify-content:center; margin-top:1rem; }
  .dot { height:0.5rem; border-radius:999px; background:#e5e7eb; width:0.5rem; transition:all 0.3s; }
  .dot.active { width:2rem; background: linear-gradient(90deg,var(--accent-from),var(--accent-to)); }

  .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; }
  .section-title { display:flex; gap:0.75rem; align-items:center; }

  header.appbar {
    position: sticky; top:0; z-index:40; padding:1rem 0; background:var(--card); backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border); box-shadow:var(--shadow);
  }

  .notif {
    position: fixed; left:50%; transform:translateX(-50%); top:1rem; z-index:80;
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to)); color:white; padding:1rem 1.5rem;
    border-radius:var(--radius); font-weight:600; box-shadow:var(--shadow); opacity:0; transition:opacity 0.3s; max-width:90%; text-align:center;
  }
  .notif.show { opacity:1; animation: bounce 0.5s; }
  @keyframes bounce { 0%,100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }

  .welcome-wrap { display:flex; align-items:center; justify-content:center; min-height:80vh; padding:1.5rem; }
  .options-list button { display:block; width:100%; text-align:left; padding:1rem; border-radius:calc(var(--radius)-4px);
    border:2px solid var(--border); background:transparent; color:var(--text); margin-bottom:0.75rem; font-weight:600; transition:all 0.2s; font-size:1rem; }
  .options-list button:hover { border-color:var(--accent-from); transform:translateX(4px); }

  .cols { display:grid; grid-template-columns:1fr; gap:1.5rem; }
  @media (min-width: 992px) { .cols { grid-template-columns:1fr 1fr; } }

  .habit-card { padding:1.5rem; border-radius:var(--radius); border:1px solid var(--border); margin-bottom:1.25rem; box-shadow:var(--shadow); }
  .green-panel { background: linear-gradient(135deg,var(--green-from),var(--green-to)); color:white; padding:1.5rem; border-radius:calc(var(--radius)-4px); text-align:center; box-shadow: 0 10px 30px rgba(16,185,129,0.3); }

  .calendar-grid { display:grid; grid-template-columns: repeat(10,1fr); gap:0.375rem; }
  .day { aspect-ratio:1/1; border-radius:4px; background:var(--border); transition:all 0.2s; }
  .day.done { background:var(--green-from); }

  .modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display:flex; align-items:center; justify-content:center; padding:1.25rem; z-index:60; opacity:0; transition:opacity 0.3s; }
  .modal-overlay.show { opacity:1; }
  .modal { max-width:640px; width:100%; background:var(--card); padding:1.5rem; border-radius:var(--radius); border:1px solid var(--border); transform: scale(0.95); opacity:0; transition:all 0.3s; max-height:90vh; overflow-y:auto; }
  .modal.show { transform: scale(1); opacity:1; }

  @keyframes spin { to { transform: rotate(360deg); } }
  .spin { animation: spin 1s linear infinite; }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
  .pulse { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }

  .stat-box { padding:1rem; border-radius:12px; text-align:center; }
  .stat-box.yellow { background: linear-gradient(135deg,#fef3c7,#fde68a); }
  .stat-box.orange { background: linear-gradient(135deg,#fed7aa,#fdba74); }
  .stat-box.red { background: linear-gradient(135deg,#fecaca,#fca5a5); }
  .dark .stat-box { background: rgba(255,255,255,0.05); }

  .chat-container {
    display: flex;
    flex-direction: column;
    height: 500px;
    max-height: 70vh;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .chat-message {
    display: flex;
    gap: 0.75rem;
    animation: slideIn 0.3s;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-message.user {
    flex-direction: row-reverse;
  }

  .chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .chat-bubble {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    word-wrap: break-word;
  }

  .chat-message.user .chat-bubble {
    background: linear-gradient(135deg,var(--accent-from),var(--accent-to));
    color: white;
    border-bottom-right-radius: 0.25rem;
  }

  .chat-message.assistant .chat-bubble {
    background: var(--border);
    color: var(--text);
    border-bottom-left-radius: 0.25rem;
  }

  .chat-input-area {
    padding: 1rem;
    border-top: 1px solid var(--border);
  }

  .quick-questions {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }

  .quick-question-btn {
    padding: 0.5rem 0.75rem;
    border-radius: 999px;
    background: rgba(124,58,237,0.1);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 0.8125rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .quick-question-btn:hover {
    background: rgba(124,58,237,0.2);
    transform: translateY(-2px);
  }

  .typing-indicator {
    display: flex;
    gap: 0.25rem;
    padding: 0.75rem 1rem;
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--muted);
    animation: typing 1.4s infinite;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
    30% { transform: translateY(-10px); opacity: 1; }
  }

  .challenge-card {
    padding: 1.5rem;
    border-radius: var(--radius);
    border: 2px solid var(--border);
    margin-bottom: 1.5rem;
    background: var(--card);
    transition: all 0.3s;
  }

  .challenge-card:hover {
    border-color: var(--accent-from);
    transform: translateY(-2px);
  }

  .challenge-card.active {
    border-color: var(--green-from);
    background: rgba(16,185,129,0.05);
  }

  .challenge-progress {
    height: 8px;
    background: var(--border);
    border-radius: 999px;
    overflow: hidden;
    margin: 1rem 0;
  }

  .challenge-progress-bar {
    height: 100%;
    background: linear-gradient(90deg,var(--green-from),var(--green-to));
    transition: width 0.3s;
  }

  .task-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 8px;
    background: rgba(255,255,255,0.5);
    margin-bottom: 0.5rem;
    transition: all 0.2s;
  }

  .task-item.completed {
    opacity: 0.6;
  }

  .task-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  .premium-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(124,58,237,0.95), rgba(236,72,153,0.95));
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius);
    backdrop-filter: blur(4px);
  }

  .spinner {
    width: 1rem;
    height: 1rem;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .habit-limit-banner {
    background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.2));
    border: 2px solid var(--gold);
    border-radius: var(--radius);
    padding: 1rem;
    margin-bottom: 1rem;
    text-align: center;
  }

  #emergency-overlay { position: fixed; inset: 0; background: linear-gradient(180deg, rgba(220,38,38,0.98), rgba(153,27,27,0.95)); display: none; z-index: 200; color: white; align-items: center; justify-content: center; padding: 1.25rem; }
  #emergency-overlay.show { display:flex; }
  .emergency-card { width:100%; max-width:720px; text-align:center; border-radius:18px; padding:1.5rem; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 40px rgba(239,68,68,0.45); border:1px solid rgba(255,255,255,0.06); }
  .emergency-head { font-size:2.5rem; font-weight:900; letter-spacing:2px; margin-bottom:0.5rem; }
  .emergency-sub { font-size:1.25rem; margin-bottom:1rem; opacity:0.95; }
  #emergency-video { width:100%; height:360px; max-height:60vh; background:black; border-radius:12px; object-fit:cover; border:4px solid rgba(0,0,0,0.2); }
  #camera-fallback { width:100%; height:360px; background:black; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; opacity:1; }

  #coach-text { font-size:1.125rem; min-height:60px; margin-top:1rem; font-weight:700; }
  .typing { display:inline-block; }

  @keyframes subtle-glow { 0% { box-shadow: 0 0 0px rgba(99,102,241,0.0), 0 0 0px rgba(99,102,241,0.0); } 50% { box-shadow: 0 0 10px rgba(99,102,241,0.4), 0 0 30px rgba(99,102,241,0.2); } 100% { box-shadow:0 0 0px rgba(99,102,241,0.0), 0 0 0px rgba(99,102,241,0.0); } }
  #breathingCircle { width:100%; height:100%; background: linear-gradient(135deg,#a5b4fc,#3b82f6); border-radius:50%; box-shadow:0 5px 15px rgba(0,0,0,0.1), 0 10px 30px rgba(0,0,0,0.05); transform: scale(0.3); will-change: transform, box-shadow; }
  .glowing { animation: subtle-glow 5s infinite alternate ease-in-out; }

  select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%236B7280' d='M10 12l-6-6h12z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position: right 0.75rem center; background-size:1.5em 1.5em; }

  #breathingContainer { display:flex; align-items:center; justify-content:center; width:70vw; height:70vw; max-width:300px; max-height:300px; margin:0 auto; }

  @media (max-width: 640px) {
    :root { --radius: 12px; }
    .modal { padding:1rem; }
    .welcome-wrap { padding:1rem; }
    .habit-card { padding:1rem; }
    .btn { padding:0.625rem 0.875rem; }
    input, select, textarea { padding:0.625rem 0.875rem; }
    .calendar-grid { gap:0.25rem; }
    .chat-bubble { max-width: 85%; }
    #header-buttons { display:none !important; }
    #btn-burger { display:inline-flex !important; }
  }

  #mobile-menu-overlay { 
    position: fixed; 
    inset: 0; 
    background: rgba(0,0,0,0.5); 
    backdrop-filter: blur(8px);
    display: none; 
    z-index: 120; 
    align-items: flex-start; 
    justify-content: flex-end;
    padding: 0;
  }
  #mobile-menu-overlay.show { display:flex; }
  
  #mobile-menu-panel {
    width: 280px;
    height: 100vh;
    background: linear-gradient(180deg, #2c3e50 0%, #1a1f2e 100%);
    box-shadow: -5px 0 30px rgba(0,0,0,0.3);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  
  #mobile-menu-overlay.show #mobile-menu-panel {
    transform: translateX(0);
  }
  
  .mobile-menu-header {
    padding: 2rem 1.5rem 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .mobile-user-name {
    font-size: 1.5rem;
    font-weight: 800;
    color: white;
  }
  
  .mobile-menu-nav {
    flex: 1;
    padding: 1rem 0;
  }
  
  .mobile-menu-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    color: rgba(255,255,255,0.8);
    background: transparent;
    border: none;
    width: 100%;
    text-align: left;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.2s;
    position: relative;
    cursor: pointer;
  }
  
  .mobile-menu-item:hover,
  .mobile-menu-item.active {
    background: rgba(124,58,237,0.15);
    color: white;
  }
  
  .mobile-menu-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(180deg, var(--accent-from), var(--accent-to));
  }
  
  .mobile-menu-icon {
    font-size: 1.25rem;
    width: 24px;
    text-align: center;
  }
  
  .mobile-menu-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }

  .kpi { padding:1rem; background:var(--card); border:1px solid var(--border); border-radius:12px; text-align:center; }
  .num { font-size:1.75rem; font-weight:800; color:var(--text); margin-top:0.25rem; }
  .analytics-header { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:1rem; margin-bottom:1.5rem; }
  .chart-grid { display:grid; grid-template-columns:1fr; gap:1.5rem; }
  @media (min-width: 768px) { .chart-grid { grid-template-columns:1fr 1fr; } }
  .chart-card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:1.5rem; }
  .chart-scroll { overflow-x:auto; }
  .fixed-chart { min-width:300px; }
  .empty { text-align:center; padding:3rem; }
</style>
</head>
<body>
<div id="app">
  <div id="notification" class="notif" role="alert" aria-live="polite"></div>

  <header class="appbar" role="banner" id="main-header" style="display:none">
    <div class="wrap">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <div>
          <h1 class="flex heading" style="align-items:center;gap:0.625rem;font-size:1.75rem">
            <span>UNDO</span>
            <span id="premium-badge-header" style="display:none" class="premium-badge">
              üëë PREMIUM
            </span>
          </h1>
          <div id="greeting" class="small muted">Hey Friend!</div>
        </div>
        <div class="flex" style="gap:0.5rem;align-items:center">
          <button id="btn-burger" class="btn btn-ghost" title="Menu" aria-label="Open menu" style="display:none;font-size:1.25rem">‚ò∞</button>
          <div id="header-buttons" style="display:flex;gap:0.5rem;align-items:center">
            <button id="btn-home" class="btn btn-ghost" title="Go Home">üè†</button>
            <button id="btn-ai-coach" class="btn btn-ghost" title="AI Coach">ü§ñ</button>
            <button id="btn-challenges" class="btn btn-ghost" title="Challenges">üéØ</button>
            <button id="btn-breathe" class="btn btn-ghost" title="Breathing Exercise" aria-label="Open breathing exercise">üå¨Ô∏è</button>
            <button id="btn-analytics" class="btn btn-ghost" title="Analytics">üìä</button>
            <button id="btn-premium" class="btn btn-gold" title="Go Premium" style="display:none">üëë Premium</button>
            <button id="btn-dark" class="btn btn-ghost" title="Toggle Light/Dark Mode" aria-pressed="false">‚òÄÔ∏è</button>
            <button id="btn-settings" class="btn btn-ghost" title="Settings">‚öôÔ∏è</button>
            <button id="btn-logout" class="btn btn-ghost" title="Logout">üö™</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:1.5rem">
    <section id="welcome" class="welcome-wrap">
      <div class="card" style="max-width:760px;padding:2rem;width:100%">
        <div id="welcome-loading" style="display:none;text-align:center">
          <div class="spin" style="width:4rem;height:4rem;border-radius:999px;border:0.375rem solid rgba(124,58,237,0.2);border-top-color:var(--accent-from);margin:0 auto 1.5rem"></div>
          <div id="loading-text" class="heading" style="font-size:1.25rem;animation:pulse 2s infinite"></div>
        </div>

        <div id="welcome-content">
          <div style="text-align:center;margin-bottom:2rem">
            <div style="font-size:4rem;margin-bottom:0.5rem">‚Ü©Ô∏è</div>
            <h2 class="heading" style="font-size:2.5rem;margin:0.5rem 0">UNDO</h2>
            <div class="small muted" style="font-size:1.125rem">Quit Bad. Build Good.</div>
          </div>

          <div id="login-step" style="text-align:center; margin-bottom:2rem;">
            <h3 class="heading" style="font-size:1.5rem; margin-bottom:1rem">Sign In to UNDO</h3>
            <div id="g_id_onload"
                data-client_id="YOUR_GOOGLE_CLIENT_ID" 
                data-context="signin"
                data-ux_mode="popup"
                data-callback="handleCredentialResponse"
                data-auto_prompt="false">
            </div>
            <div class="g_id_signin"
                data-type="standard"
                data-shape="rectangular"
                data-theme="outline"
                data-text="signin_with"
                data-size="large"
                data-logo_alignment="left">
            </div>
            <div class="small muted" style="margin-top:1rem">Sign in with Google to securely save your progress and access the AI Coach.</div>
          </div>

          <div id="question-wrap" class="flex" style="flex-direction:column;gap:1rem;display:none">
            <div>
              <p id="q-text" class="heading" style="font-size:1.5rem;margin-bottom:1rem">What's your name?</p>
              <div id="q-input-wrap"></div>
            </div>

            <div class="flex" style="gap:0.75rem">
              <button id="btn-back-question" class="btn btn-ghost" style="flex:1;display:none">Back</button>
              <button id="btn-next-question" class="btn btn-primary" style="flex:1">Continue</button>
            </div>

            <div id="dotbar" class="dotbar"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="app-main" style="display:none">
      <div id="dashboard-view">
        <div id="habit-limit-banner" class="habit-limit-banner" style="display:none">
          <div style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem">
            ‚ö†Ô∏è Free Plan Limit: 3 Habits
          </div>
          <div class="small" style="margin-bottom:0.75rem">
            You've reached the free plan limit. Upgrade to Premium for unlimited habits!
          </div>
          <button id="upgrade-from-banner" class="btn btn-gold">
            üëë Upgrade to Premium
          </button>
        </div>

        <div class="cols">
          <div>
            <div class="section-header">
              <div class="section-title">
                <div style="font-size:1.5rem;color:var(--danger)">‚ùå</div>
                <div>
                  <div class="heading" style="font-size:1.5rem">Quit Habits (<span id="quit-count">0</span>)</div>
                  <div class="small muted">Track what you want to stop</div>
                </div>
              </div>
              <button id="add-quit" class="btn btn-danger">+ Add</button>
            </div>
            <div id="quit-list"></div>
          </div>

          <div>
            <div class="section-header">
              <div class="section-title">
                <div style="font-size:1.5rem;color:var(--green-from)">‚úÖ</div>
                <div>
                  <div class="heading" style="font-size:1.5rem">Build Habits (<span id="build-count">0</span>)</div>
                  <div class="small muted">Habits to build</div>
                </div>
              </div>
              <button id="add-build" class="btn btn-success">+ Add</button>
            </div>
            <div id="build-list"></div>
          </div>
        </div>
      </div>

      <div id="ai-coach-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">ü§ñ</span>
          AI Coach
          <span class="premium-badge">üëë PREMIUM</span>
        </h2>

        <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
          <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
              <div class="chat-message assistant">
                <div class="chat-avatar">ü§ñ</div>
                <div class="chat-bubble">
                  Hi! I'm your AI coach powered by GPT-4. I'm here to support you on your journey. How can I help you today?
                </div>
              </div>
            </div>

            <div class="chat-input-area">
              <div class="quick-questions" id="quick-questions">
                <button class="quick-question-btn" data-question="How do I stay motivated?">üí™ Stay motivated</button>
                <button class="quick-question-btn" data-question="I'm having cravings, help!">üÜò Craving help</button>
                <button class="quick-question-btn" data-question="Tips for my habits?">üí° Get tips</button>
                <button class="quick-question-btn" data-question="I relapsed, what now?">üîÑ After relapse</button>
              </div>
              
              <div style="display:flex;gap:0.5rem">
                <input 
                  type="text" 
                  id="chat-input" 
                  placeholder="Ask me anything about your habits..." 
                  style="flex:1"
                />
                <button id="chat-send" class="btn btn-primary" style="padding:0.75rem 1.5rem">
                  Send
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="challenges-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üéØ</span>
          Challenge Packs
          <span class="premium-badge">üëë PREMIUM</span>
        </h2>

        <div id="challenges-container"></div>
      </div>

      <div id="premium-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üëë</span>
          Go Premium
        </h2>

        <div class="card" style="padding:2rem;text-align:center;margin-bottom:2rem;background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(245,158,11,0.1))">
          <div style="font-size:3rem;margin-bottom:1rem">‚ú®</div>
          <h3 class="heading" style="font-size:2rem;margin-bottom:1rem">Unlock Your Full Potential</h3>
          <div class="small muted" style="font-size:1.125rem;margin-bottom:2rem">
            Get access to AI coaching, unlimited habits, and premium challenges
          </div>

          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem;text-align:left">
            <div>
              <div style="font-size:2rem;margin-bottom:0.5rem">ü§ñ</div>
              <div class="heading" style="font-size:1.125rem;margin-bottom:0.5rem">AI Coach</div>
              <div class="small muted">24/7 personalized coaching powered by GPT-4</div>
            </div>
            <div>
              <div style="font-size:2rem;margin-bottom:0.5rem">üéØ</div>
              <div class="heading" style="font-size:1.125rem;margin-bottom:0.5rem">Challenge Packs</div>
              <div class="small muted">Structured 30-90 day transformation programs</div>
            </div>
            <div>
              <div style="font-size:2rem;margin-bottom:0.5rem">‚àû</div>
              <div class="heading" style="font-size:1.125rem;margin-bottom:0.5rem">Unlimited Habits</div>
              <div class="small muted">Track as many habits as you need</div>
            </div>
            <div>
              <div style="font-size:2rem;margin-bottom:0.5rem">üìä</div>
              <div class="heading" style="font-size:1.125rem;margin-bottom:0.5rem">Advanced Analytics</div>
              <div class="small muted">Deep insights into your patterns</div>
            </div>
            <div>
              <div style="font-size:2rem;margin-bottom:0.5rem">üíæ</div>
              <div class="heading" style="font-size:1.125rem;margin-bottom:0.5rem">Priority Backup</div>
              <div class="small muted">Automatic cloud backup of all your data</div>
            </div>
            <div>
              <div style="font-size:2rem;margin-bottom:0.5rem">üé®</div>
              <div class="heading" style="font-size:1.125rem;margin-bottom:0.5rem">Custom Themes</div>
              <div class="small muted">Personalize your experience</div>
            </div>
          </div>

          <div style="background:white;border-radius:var(--radius);padding:2rem;margin-bottom:2rem;box-shadow:var(--shadow)">
            <div class="heading" style="font-size:2.5rem;color:#7c3aed;margin-bottom:0.5rem">$9.99/month</div>
            <div class="small muted" style="margin-bottom:1.5rem">7-day free trial ‚Ä¢ Cancel anytime</div>
            <button id="start-trial-btn" class="btn btn-gold btn-wide" style="font-size:1.125rem;padding:1rem">
              üöÄ Start 7-Day Free Trial
            </button>
            <div class="small muted" style="margin-top:1rem">No credit card required for trial</div>
          </div>

          <div class="small muted">
            Already premium? Your trial ends on <span id="trial-end-date">--</span>
          </div>
        </div>
      </div>

      <div id="analytics-page" style="display:none">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">üìä</span>
          Analytics
        </h2>
        
        <div class="card" style="padding:1.5rem;margin-bottom:1.5rem">
          <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap">
            <div style="flex:1;min-width:200px">
              <label class="small muted" for="habitSelectAnalytics" style="display:block;margin-bottom:0.5rem;font-weight:600">Select Habit</label>
              <select id="habitSelectAnalytics" aria-label="Select habit"></select>
            </div>
            <div>
              <label class="small muted" for="rangeSelect" style="display:block;margin-bottom:0.5rem;font-weight:600">Time Range</label>
              <select id="rangeSelect" aria-label="Select range">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 90 days</option>
              </select>
            </div>
            <div style="margin-top:auto">
              <button id="refreshAnalytics" class="btn btn-primary">Refresh</button>
            </div>
          </div>

          <div id="analyticsMain">
            <div id="kpiRow" class="analytics-header"></div>
            
            <div id="chartsWrap" class="chart-grid">
              <div class="chart-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
                  <div class="small muted" style="font-weight:600">7-Day Trend</div>
                </div>
                <div class="chart-scroll">
                  <canvas id="chart7" class="fixed-chart" aria-label="7 day chart"></canvas>
                </div>
              </div>

              <div class="chart-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
                  <div class="small muted" style="font-weight:600">Today - Hourly Progress</div>
                </div>
                <div class="chart-scroll">
                  <canvas id="chart24" class="fixed-chart" aria-label="24 hour chart"></canvas>
                </div>
              </div>
            </div>

            <div id="emptyState" class="empty" style="display:none;padding:3rem;text-align:center">
              <div style="font-size:3rem;opacity:0.3;margin-bottom:1rem">üìä</div>
              <p class="muted" style="font-size:1.125rem">No habits found. Add a habit to see analytics here.</p>
            </div>
          </div>
        </div>
      </div>

      <section id="breathing-section" style="display:none; margin-top:1.5rem;">
        <div class="card" style="padding:1.5rem; max-width:760px; margin:0 auto;">
          <header style="text-align:center; margin-bottom:1rem;">
            <h2 class="heading" style="font-size:1.5rem">Breathwork Guide üå¨Ô∏è</h2>
          </header>

          <div style="margin-bottom:1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
            <div style="flex:1;min-width:150px">
              <label class="small muted" for="modeSelect" style="display:block;margin-bottom:0.5rem;font-weight:600">Mode</label>
              <select id="modeSelect">
                <option value="coherence">Coherence (5:5)</option>
                <option value="box">Box (4:4:4:4)</option>
                <option value="military">Military (4:0:6:0)</option>
              </select>
            </div>
            <div style="flex:1;min-width:150px">
              <label class="small muted" for="freqSelect" style="display:block;margin-bottom:0.5rem;font-weight:600">Tone Frequency</label>
              <select id="freqSelect">
                <option value="528">528 Hz (Love)</option>
                <option value="432">432 Hz (Nature)</option>
                <option value="741">741 Hz (Purity)</option>
                <option value="0" selected>None</option>
              </select>
            </div>
          </div>

          <div id="breathingContainer" style="margin-bottom:1.5rem; aspect-ratio:1/1;">
            <div id="breathingCircle" class="glowing"></div>
          </div>

          <div id="coach-text-wrap" style="text-align:center; min-height:60px;">
            <div id="coach-line" class="typing heading muted" style="font-size:1.125rem; font-weight:700;">
              Click start to begin your session.
            </div>
          </div>

          <div style="text-align:center; margin-top:1.5rem; display:flex; gap:1rem;">
            <button id="start-breathing" class="btn btn-primary btn-wide" style="flex:1">
              Start Session
            </button>
            <button id="stop-breathing" class="btn btn-ghost btn-wide" style="flex:1; display:none">
              Stop
            </button>
          </div>
          
        </div>
      </section>

      <section id="settings-page" style="display:none; margin-top:1.5rem;">
        <h2 class="heading" style="font-size:2rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:0.75rem">
          <span style="font-size:2rem">‚öôÔ∏è</span>
          Settings
        </h2>

        <div class="cols">
          <div>
            <div class="card" style="padding:1.5rem; margin-bottom:1.5rem;">
              <h3 class="heading" style="font-size:1.25rem; margin-bottom:1rem;">Account & Profile</h3>
              <div style="margin-bottom:1rem;">
                <label class="small muted" style="display:block;margin-bottom:0.5rem;font-weight:600">Logged in as</label>
                <p id="user-email-setting" class="heading" style="margin:0; font-size:1.125rem;">...</p>
              </div>
              <div style="margin-bottom:1rem;">
                <label class="small muted" for="setting-name" style="display:block;margin-bottom:0.5rem;font-weight:600">Your Name</label>
                <input id="setting-name" />
              </div>
              <div style="margin-bottom:1rem;">
                <label class="small muted" for="setting-why" style="display:block;margin-bottom:0.5rem;font-weight:600">Your Motivation (Why)</label>
                <textarea id="setting-why" placeholder="Why is this important to you? The AI coach uses this!"></textarea>
              </div>
              <button id="save-profile" class="btn btn-primary btn-wide">
                Save Profile
              </button>
            </div>
          </div>

          <div>
            <div class="card" style="padding:1.5rem; margin-bottom:1.5rem;">
              <h3 class="heading" style="font-size:1.25rem; margin-bottom:1rem;">Data Management</h3>
              <p class="small muted" style="margin-bottom:1rem;">
                Export or import your local progress data.
              </p>
              <div class="flex gap-4">
                <button id="export-data-btn" class="btn btn-ghost" style="flex:1">
                  Export Data
                </button>
                <input type="file" id="import-data-file" accept=".json" style="display:none" />
                <button id="import-data-btn" class="btn btn-ghost" style="flex:1">
                  Import Data
                </button>
              </div>
              <div style="margin-top:1.5rem;">
                <button id="reset-data-btn" class="btn btn-danger btn-wide">
                  ‚ö†Ô∏è Clear All Local Data
                </button>
                <p class="small muted" style="text-align:center;margin-top:0.5rem;">
                  This cannot be undone. You will need to log back in.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <div id="add-modal" class="modal-overlay" style="display:none">
    <div class="modal card">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:1.5rem">
        <h3 class="heading" id="add-title" style="font-size:1.5rem">Add Habit</h3>
        <button id="close-add" class="btn btn-ghost" style="padding:0.5rem">‚úï</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div>
          <label class="small" for="add-name" style="display:block;margin-bottom:0.5rem;font-weight:600">Habit Name</label>
          <input id="add-name" placeholder="e.g., Smoking, Daily Walk" />
        </div>
        
        <div id="add-category-wrap">
          <label class="small" style="display:block;margin-bottom:0.75rem;font-weight:600">Choose Category</label>
          <div id="add-category-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem"></div>
        </div>

        <div id="add-lasttime-wrap">
          <label class="small" style="display:block;margin-bottom:0.5rem;font-weight:600">Last time you did it</label>
          <input id="add-startdate" type="datetime-local" />
          <p class="small muted" style="margin-top:0.5rem">For **Quit Habits** only: When did you last engage in this habit?</p>
        </div>

        <div id="add-goal-wrap" style="display:none">
          <label class="small" for="add-daily-goal" style="display:block;margin-bottom:0.5rem;font-weight:600">Daily Goal</label>
          <div style="display:flex;align-items:center;gap:0.75rem;">
            <input id="add-daily-goal" type="number" min="1" value="1" style="width:100px;text-align:center;" />
            <span id="add-unit-label" class="heading small" style="flex:1"></span>
          </div>
          <p class="small muted" style="margin-top:0.5rem">For **Build Habits** only: How many times or units per day?</p>
        </div>
        
        <button id="btn-save-habit" class="btn btn-primary btn-wide">Save Habit</button>
      </div>
    </div>
  </div>

  <div id="relapse-modal" class="modal-overlay" style="display:none">
    <div class="modal card">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:1.5rem">
        <h3 class="heading" id="relapse-title" style="font-size:1.5rem">‚ö†Ô∏è Relapse Check-In</h3>
        <button id="close-relapse" class="btn btn-ghost" style="padding:0.5rem">‚úï</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <p class="small muted" id="relapse-habit-name" style="font-weight:600;margin:0;"></p>
        <p>It's okay. A slip-up is part of the process. Let's reset your timer and learn from this moment.</p>
        <div>
          <label class="small" for="relapse-date" style="display:block;margin-bottom:0.5rem;font-weight:600">When did the relapse occur?</label>
          <input id="relapse-date" type="datetime-local" />
        </div>
        <div>
          <label class="small" for="relapse-reason" style="display:block;margin-bottom:0.5rem;font-weight:600">What was the trigger or reason?</label>
          <textarea id="relapse-reason" placeholder="e.g., I was stressed, I was with friends who were doing it, I was bored."></textarea>
        </div>
        <button id="btn-confirm-relapse" class="btn btn-danger btn-wide">
          Reset Streak & Confirm Relapse
        </button>
      </div>
    </div>
  </div>

  <div id="emergency-overlay">
    <div class="emergency-card">
      <div style="font-size:4rem;margin-bottom:1rem;">üö®</div>
      <h2 class="emergency-head">EMERGENCY BUTTON</h2>
      <p class="emergency-sub">
        You are feeling a strong urge for <span id="emergency-habit-name-2" style="font-weight:900;"></span>.
        Stop and watch this video right now.
      </p>

      <video id="emergency-video" playsinline autoplay controls style="display:none;"></video>
      <div id="camera-fallback" style="display:none;">
        <p style="font-weight:600;">Hang in there. We are trying to activate your camera for a focus exercise. In the meantime, focus on your breath.</p>
      </div>

      <div id="coach-text-wrap-emergency" style="text-align:center; min-height:60px;">
        <div id="coach-line" class="typing heading" style="color:white; opacity:0.9; margin-top:0.5rem;">
          Take a deep breath. This craving will pass. You are stronger than this feeling.
        </div>
      </div>

      <div style="display:flex; gap:1rem; margin-top:2rem;">
        <button id="emergency-done" class="btn btn-success btn-wide" style="flex:1; padding:1rem;">
          I'm safe - urge passed
        </button>
        <button id="emergency-relapse" class="btn btn-danger btn-wide" style="flex:1; padding:1rem;">
          I relapsed, reset timer
        </button>
      </div>
    </div>
  </div>

  <div id="mobile-menu-overlay">
    <div id="mobile-menu-panel">
      <div class="mobile-menu-header">
        <div class="mobile-user-name" id="mobile-menu-name">Hey Friend</div>
        <div class="small" style="color:rgba(255,255,255,0.6);">
          <span id="mobile-menu-email">Not Logged In</span>
          <span id="mobile-menu-premium" class="premium-badge" style="display:none;">üëë PREMIUM</span>
        </div>
      </div>
      <nav class="mobile-menu-nav">
        <button class="mobile-menu-item" data-page="dashboard">
          <span class="mobile-menu-icon">üè†</span> Dashboard
        </button>
        <button class="mobile-menu-item" data-page="ai-coach">
          <span class="mobile-menu-icon">ü§ñ</span> AI Coach
        </button>
        <button class="mobile-menu-item" data-page="challenges">
          <span class="mobile-menu-icon">üéØ</span> Challenges
        </button>
        <button class="mobile-menu-item" data-page="breathing">
          <span class="mobile-menu-icon">üå¨Ô∏è</span> Breathing
        </button>
        <button class="mobile-menu-item" data-page="analytics">
          <span class="mobile-menu-icon">üìä</span> Analytics
        </button>
        <button class="mobile-menu-item" data-page="premium">
          <span class="mobile-menu-icon">üëë</span> Premium
        </button>
        <button class="mobile-menu-item" data-page="settings">
          <span class="mobile-menu-icon">‚öôÔ∏è</span> Settings
        </button>
        <button id="mobile-menu-dark-toggle" class="mobile-menu-item" data-mode="toggle">
          <span class="mobile-menu-icon">‚òÄÔ∏è</span> <span id="mobile-mode-text">Light Mode</span>
        </button>
      </nav>
      <div class="mobile-menu-footer">
        <button id="mobile-menu-logout" class="btn btn-danger btn-wide">
          Log Out
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Utility function for DOM selection
  const $ = id => document.getElementById(id);

  // Global state management
  const state = {
    screen: 'welcome', // 'welcome' or 'dashboard'
    page: 'dashboard', // 'dashboard', 'ai-coach', 'challenges', 'premium', 'analytics', 'breathing', 'settings'
    darkMode: localStorage.getItem('undo_dark_mode') === 'true',
    isPremium: localStorage.getItem('undo_premium') === 'true',
    isLoggedIn: false, // New: Google Login Status
    userData: {
      name: '',
      email: '', // New: User Email
      why: '', // User's motivation for AI context
      premiumTrialStart: null,
      premiumTrialEnd: null,
    },
    quitHabits: [],
    buildHabits: [],
    questionIndex: 0,
    answers: {},
    chatHistory: [],
    // Modals
    addModalOpen: false,
    relapseModalOpen: false,
    // Analytics
    analyticsChart: null,
    analyticsChart24: null,
    // Challenge
    activeChallenge: null,
    // Emergency
    emergencyHabit: null,
    emergencyStream: null,
    // Environment Variables
    env: {}
  };

  // Environment variable holders
  let GOOGLE_CLIENT_ID = '';
  let OPENROUTER_API_KEY = '';

  // Data structure constants
  const HABIT_ICONS = {
    smoking: 'üö¨', alcohol: 'üçª', sugar: 'üç©', porn: 'üîû', shopping: 'üõçÔ∏è',
    social_media: 'üì±', gaming: 'üéÆ', news: 'üì∞', procrastination: ' procrastinate',
    exercise: 'üèãÔ∏è', reading: 'üìö', meditation: 'üßò', water: 'üíß', sleep: 'üò¥',
    money: 'üí∞', coding: 'üíª', writing: '‚úçÔ∏è', cleaning: 'üßπ',
    other: 'üí™', default: 'üí°'
  };

  const CATEGORY_UNITS = {
    exercise: { unit: 'minutes', default: 30 },
    reading: { unit: 'pages', default: 10 },
    meditation: { unit: 'minutes', default: 10 },
    water: { unit: 'glasses', default: 8 },
    sleep: { unit: 'hours', default: 8 },
    coding: { unit: 'hours', default: 1 },
    writing: { unit: 'words', default: 500 },
    cleaning: { unit: 'tasks', default: 1 },
    other: { unit: 'times', default: 1 }
  };

  const ALL_CATEGORIES = {
    smoking: { type: 'quit', label: 'Smoking üö¨' },
    alcohol: { type: 'quit', label: 'Alcohol üçª' },
    sugar: { type: 'quit', label: 'Sugar/Junk Food üç©' },
    porn: { type: 'quit', label: 'Porn/Masturbation üîû' },
    social_media: { type: 'quit', label: 'Social Media Scrolling üì±' },
    gaming: { type: 'quit', label: 'Gaming üéÆ' },
    procrastination: { type: 'quit', label: 'Procrastination üìù' },
    
    exercise: { type: 'build', label: 'Exercise üèãÔ∏è' },
    reading: { type: 'build', label: 'Reading üìö' },
    meditation: { type: 'build', label: 'Meditation üßò' },
    water: { type: 'build', label: 'Drinking Water üíß' },
    sleep: { type: 'build', label: 'Better Sleep üò¥' },
    money: { type: 'build', label: 'Saving Money üí∞' },
    other: { type: 'both', label: 'Other/Custom üí°' }
  };

  const QUESTIONS = [
    { q: "What's your name?", type: 'input', key: 'name', inputType: 'text', default: '' },
    { 
      q: "What is the biggest thing you want to **QUIT**?", 
      type: 'select', 
      key: 'quitCategory', 
      options: Object.entries(ALL_CATEGORIES).filter(([, c]) => c.type === 'quit' || c.type === 'both').map(([key, c]) => ({ label: c.label, value: key }))
    },
    { q: "What is one new habit you want to **BUILD**?", 
      type: 'select', 
      key: 'buildCategory', 
      options: Object.entries(ALL_CATEGORIES).filter(([, c]) => c.type === 'build' || c.type === 'both').map(([key, c]) => ({ label: c.label, value: key }))
    },
    { q: "Why is this journey important to you? (Your big **WHY**)", type: 'textarea', key: 'why', default: 'To live a healthier, happier life.' }
  ];

  const COACH_LINES = [
    "You can do this. Stay strong. One minute at a time.",
    "Breathe in for four, hold for four, exhale for six. Focus on your lungs.",
    "This feeling is a wave. It will pass. Let it wash over you.",
    "Remember your 'Why'. What are you fighting for right now?",
    "Delay. Distract. Decide. You are in control of your next action."
  ];

  const CHALLENGE_PACKS = {
    'dopamine-30': {
      id: 'dopamine-30',
      name: '‚ö° 30-Day Dopamine Detox',
      description: 'Reset your reward system by cutting out instant gratification.',
      duration: 30,
      tasks: [
        { day: 1, task: 'No social media, gaming, or junk food for 24 hours', completed: false },
        { day: 3, task: 'Spend 30 minutes in nature', completed: false },
        { day: 7, task: 'Meditate for 10 minutes', completed: false },
        { day: 14, task: 'Read a book for 30 minutes', completed: false },
        { day: 21, task: 'Journal about boredom', completed: false },
        { day: 30, task: 'Plan your long-term dopamine budget', completed: false }
      ]
    },
    'fit-60': {
      id: 'fit-60',
      name: 'üèãÔ∏è 60-Day Fitness Foundation',
      description: 'Establish a non-negotiable routine for strength and endurance.',
      duration: 60,
      tasks: [
        { day: 1, task: 'Walk 10 minutes (easy start)', completed: false },
        { day: 7, task: 'Complete 3 structured workouts this week', completed: false },
        { day: 15, task: 'Measure and record baseline weight/body composition', completed: false },
        { day: 30, task: 'Complete a 30-minute workout, 5 times this week', completed: false },
        { day: 45, task: 'Try a new form of exercise (yoga, swimming, etc.)', completed: false },
        { day: 60, task: 'Final photos and measurements - Compare!', completed: false }
      ]
    },
    'mindfulness-90': {
      id: 'mindfulness-90',
      name: 'üßò 90-Day Mindfulness Mastery',
      description: 'Build a sustainable meditation and mindfulness practice',
      duration: 90,
      tasks: [
        { day: 1, task: '5 min meditation - Focus on breath', completed: false },
        { day: 3, task: '7 min meditation - Body scan', completed: false },
        { day: 7, task: '10 min meditation - First week!', completed: false },
        { day: 14, task: '12 min meditation - Notice thoughts', completed: false },
        { day: 21, task: '15 min meditation - 3 weeks of practice', completed: false },
        { day: 30, task: '20 min meditation - One month!', completed: false },
        { day: 60, task: '25 min meditation - Deep practice', completed: false },
        { day: 90, task: '30 min meditation - Mastery achieved!', completed: false }
      ]
    },
    'reboot-90': {
      id: 'reboot-90',
      name: 'üîÑ 90-Day Complete Reboot',
      description: 'Comprehensive recovery and transformation program',
      duration: 90,
      tasks: [
        { day: 1, task: 'Install website blockers and accountability software', completed: false },
        { day: 1, task: 'Write down a detailed relapse prevention plan', completed: false },
        { day: 3, task: 'Call an accountability partner', completed: false },
        { day: 7, task: 'Start a new daily build habit', completed: false },
        { day: 30, task: 'Review and update your triggers list', completed: false },
        { day: 60, task: 'Write a letter to your future self', completed: false },
        { day: 90, task: 'Celebrate your 90-day milestone!', completed: false }
      ]
    }
  };

  // Helper functions
  function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
  function saveState() { localStorage.setItem('undo_state', JSON.stringify(state)); }
  function loadState() {
    try {
      const savedState = JSON.parse(localStorage.getItem('undo_state'));
      if (savedState) {
        // Merge saved state to keep new default properties
        Object.assign(state, savedState);
        // Ensure new nested properties exist
        state.userData = state.userData || {};
        state.userData.email = state.userData.email || savedState.userData.email || ''; 
        state.isLoggedIn = state.isLoggedIn || false;
      }
    } catch (e) { console.error("Error loading state", e); }
  }

  function showNotification(message) {
    const notif = $('notification');
    notif.textContent = message;
    notif.classList.add('show');
    setTimeout(() => { notif.classList.remove('show'); }, 3000);
  }

  function calculateStreak(completions, dailyGoal) {
    let streak = 0;
    let currentDate = new Date();
    currentDate.setHours(0, 0, 0, 0);

    while (true) {
      const dateString = currentDate.toISOString().split('T')[0];
      const completionValue = completions[dateString] || 0;

      if (completionValue >= dailyGoal) {
        streak++;
        currentDate.setDate(currentDate.getDate() - 1);
      } else {
        break;
      }
    }
    return streak;
  }

  function formatDuration(seconds) {
    if (seconds < 60) return `${Math.floor(seconds)} seconds`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes`;
    if (seconds < 86400) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `${hours}h ${minutes}m`;
    }
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return `${days}d ${hours}h ${minutes}m`;
  }

  // AI Functionality
  async function callAICoach(message) {
    if (!OPENROUTER_API_KEY) {
      return "The AI Coach is not configured. Please add your OPENROUTER_API_KEY to the .env file.";
    }
    if (!state.isPremium) {
      return "The AI Coach is a **Premium** feature. Please upgrade to unlock personalized coaching.";
    }

    // New: Pass all relevant user data to the AI for context
    const systemPrompt = `You are UNDO's AI Coach, powered by GPT-4o, specializing in habit reversal and building. You have access to the user's current data.
    User data: 
    - Name: ${state.userData.name || 'User'} 
    - Email: ${state.userData.email || 'Not specified'}
    - Quit habits: ${state.quitHabits.map(h => h.name + ' (Last slip-up: ' + (h.lastTime || 'Never') + ')').join('; ') || 'None yet'} 
    - Build habits: ${state.buildHabits.map(h => h.name + ' (Goal: ' + h.dailyGoal + ' ' + h.unit + ')').join('; ') || 'None yet'} 
    - Motivation: ${state.userData.why || 'Not specified'}
    
    Be supportive, evidence-based, and actionable. Keep responses concise, under 150 words. Use emojis sparingly.`;

    try {
      const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
          "HTTP-Referer": window.location.href, // Required for OpenRouter
          "X-Title": "UNDO Habit Tracker", // Required for OpenRouter
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          "model": "openai/gpt-4o",
          "messages": [
            { "role": "system", "content": systemPrompt },
            ...state.chatHistory.slice(-10), // Send last 10 messages for context
            { "role": "user", "content": message }
          ],
          "temperature": 0.7,
          "max_tokens": 300
        })
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      const aiResponse = data.choices[0].message.content;

      // Add messages to history only after successful API call
      state.chatHistory.push({ role: 'user', content: message });
      state.chatHistory.push({ role: 'assistant', content: aiResponse });
      if (state.chatHistory.length > 20) { state.chatHistory = state.chatHistory.slice(-20); }
      saveState();

      return aiResponse;

    } catch (error) {
      console.error('AI Error:', error);
      return "I'm having trouble connecting right now. Please try again in a moment. üí≠";
    }
  }

  function renderChatMessage(role, content) {
    const messagesContainer = $('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}`;
    
    // Auto-link URLs
    const processedContent = content.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target="_blank" style="color:var(--accent-from); text-decoration:underline;">${url}</a>`);

    messageDiv.innerHTML = `
      <div class="chat-avatar">${role === 'user' ? 'üë§' : 'ü§ñ'}</div>
      <div class="chat-bubble">${processedContent.replace(/\n/g, '<br>')}</div>
    `;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function handleChatMessage(message) {
    if (!message.trim()) return;

    // Clear input and render user message
    const input = $('chat-input');
    input.value = '';
    renderChatMessage('user', message);

    // Show typing indicator
    const messagesContainer = $('chat-messages');
    const typingIndicator = document.createElement('div');
    typingIndicator.className = 'chat-message assistant';
    typingIndicator.id = 'typing-indicator';
    typingIndicator.innerHTML = `
      <div class="chat-avatar">ü§ñ</div>
      <div class="typing-indicator chat-bubble" style="background:var(--border);">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
    messagesContainer.appendChild(typingIndicator);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    // Call API
    callAICoach(message).then(aiResponse => {
      // Remove typing indicator
      if (document.getElementById('typing-indicator')) {
        document.getElementById('typing-indicator').remove();
      }
      renderChatMessage('assistant', aiResponse);
    }).catch(error => {
      // Handle API errors
      if (document.getElementById('typing-indicator')) {
        document.getElementById('typing-indicator').remove();
      }
      renderChatMessage('assistant', "An error occurred while fetching the response. Please check your API key.");
    });
  }

  // --- Onboarding / Welcome Screen Logic ---

  // New: Google Login Callback
  window.handleCredentialResponse = async (response) => {
    try {
      // Decode the JWT token to get user data
      const token = response.credential;
      const userObject = JSON.parse(atob(token.split('.')[1]));
      
      state.userData.email = userObject.email;
      state.userData.name = userObject.name || userObject.given_name || 'Friend';
      state.isLoggedIn = true;
      saveState();
      
      showLoading('Authenticated! Checking user status...');
      
      // Check if it's a first-time user (no existing user data besides the new login info)
      if (state.quitHabits.length === 0 && state.buildHabits.length === 0) {
          // First time user, proceed to questionnaire
          setTimeout(() => {
            $('welcome-loading').style.display='none';
            $('login-step').style.display = 'none';
            $('question-wrap').style.display = 'flex';
            $('welcome-content').style.display = 'block';
            state.questionIndex = 0;
            renderQuestion();
          }, 1000);
      } else {
          // Existing user, go straight to dashboard
          setTimeout(() => {
            finishOnboarding();
          }, 1500);
      }
    } catch (e) {
      console.error("Login Error:", e);
      showLoading('Login failed. Please try again.');
      setTimeout(() => { 
        $('welcome-loading').style.display='none';
        $('welcome-content').style.display = 'block';
      }, 2000);
    }
  };

  function showLoading(text) {
    $('welcome-content').style.display = 'none';
    $('welcome-loading').style.display = 'block';
    $('loading-text').textContent = text;
  }

  function renderQuestion() {
    const idx = state.questionIndex;
    const q = QUESTIONS[idx];

    $('q-text').textContent = q.q;
    const wrap = $('q-input-wrap');
    wrap.innerHTML = '';
    $('btn-back-question').style.display = idx > 0 ? 'inline-flex' : 'none';
    $('btn-next-question').textContent = idx === QUESTIONS.length - 1 ? 'Finish Setup' : 'Continue';

    if (q.type === 'select') {
      const list = document.createElement('div');
      list.className = 'options-list';
      q.options.forEach(opt => {
        const b = document.createElement('button');
        b.textContent = opt.label || opt.value;
        b.classList.toggle('btn-primary', state.answers[idx] === opt.value);
        b.onclick = () => {
          state.answers[idx] = opt.value || opt.label;
          setTimeout(() => handleQuestionSubmit(), 200);
        };
        list.appendChild(b);
      });
      wrap.appendChild(list);
    } else if (q.type === 'input' || q.type === 'textarea') {
      let input;
      if (q.type === 'textarea') {
        input = document.createElement('textarea');
        input.placeholder = 'Type your answer here...';
      } else {
        input = document.createElement('input');
        input.type = q.inputType || 'text';
        input.placeholder = q.placeholder || 'Type your answer here...';
      }
      input.id = 'q-input';
      input.value = state.answers[idx] || q.default || '';
      input.oninput = (e) => { state.answers[idx] = e.target.value; };
      wrap.appendChild(input);
    }

    renderDotBar();
  }

  function renderDotBar() {
    const dotbar = $('dotbar');
    dotbar.innerHTML = '';
    QUESTIONS.forEach((_, i) => {
      const dot = document.createElement('div');
      dot.className = `dot ${i <= state.questionIndex ? 'active' : ''}`;
      dotbar.appendChild(dot);
    });
  }

  function handleQuestionSubmit() {
    const idx = state.questionIndex;
    const q = QUESTIONS[idx];

    // Basic validation for input/textarea
    if ((q.type === 'input' || q.type === 'textarea') && !state.answers[idx]) {
      const input = $('q-input');
      input.style.borderColor = 'var(--danger)';
      setTimeout(() => input.style.borderColor = 'var(--border)', 1000);
      showNotification('Please provide an answer to continue.');
      return;
    }
    
    // Check for select validation (already handled by button click saving the answer)
    if (q.type === 'select' && !state.answers[idx]) {
      showNotification('Please select an option to continue.');
      return;
    }

    if (idx < QUESTIONS.length - 1) {
      state.questionIndex++;
      renderQuestion();
    } else {
      processOnboardingAnswers();
    }
    saveState();
  }

  function processOnboardingAnswers() {
    showLoading('Setting up your app...');
    setTimeout(() => {
      state.userData.name = state.answers[0] || 'Friend';
      state.userData.why = state.answers[3] || 'To live a healthier, happier life.';

      // Quit Habit Setup
      const qc = state.answers[1];
      const qCategory = ALL_CATEGORIES[qc] || ALL_CATEGORIES.other;
      state.quitHabits = [{
        id: uid(),
        name: qCategory.label.split(' ')[0], // Use base name like "Smoking"
        icon: HABIT_ICONS[qc] || '‚ùå',
        lastTime: new Date().toISOString().substring(0, 16),
        category: qc,
        type: 'quit'
      }];

      // Build Habit Setup
      const bc = state.answers[2];
      const bCategory = ALL_CATEGORIES[bc] || ALL_CATEGORIES.other;
      const unitInfo = CATEGORY_UNITS[bc] || CATEGORY_UNITS.other;
      state.buildHabits = [{
        id: uid(),
        name: bCategory.label.split(' ')[0], // Use base name like "Exercise"
        icon: HABIT_ICONS[bc] || 'üí™',
        dailyGoal: unitInfo.default,
        unit: unitInfo.unit,
        completions: {},
        currentStreak: 0,
        bestStreak: 0,
        category: bc,
        type: 'build'
      }];

      finishOnboarding();
    }, 1500);
  }

  function finishOnboarding() {
    state.loading = false;
    $('welcome-loading').style.display = 'none';
    state.screen = 'dashboard';
    state.page = 'dashboard';
    saveState();
    renderAll();
  }

  // --- Habit Rendering Logic (Similar to previous content) ---

  function renderHabitCard(habit) {
    const isQuit = habit.type === 'quit';
    const card = document.createElement('div');
    card.className = 'habit-card';

    // 1. TOP SECTION (Name, Icon, Edit/Emergency Buttons)
    const topSection = document.createElement('div');
    topSection.style.cssText = 'display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem;';
    topSection.innerHTML = `
      <div>
        <h3 class="heading" style="font-size:1.25rem;">
          <span style="font-size:1.5rem;margin-right:0.5rem">${habit.icon}</span>
          ${habit.name}
        </h3>
        <p class="small muted" style="margin-top:0.25rem;">
          Category: ${ALL_CATEGORIES[habit.category]?.label.split(' ')[0] || 'Custom'}
        </p>
      </div>
      <div style="display:flex;gap:0.5rem;">
        ${isQuit ? `<button class="btn btn-danger" style="padding:0.5rem;" title="Emergency" onclick="openEmergencyModal('${habit.id}')">üö®</button>` : ''}
        <button class="btn btn-ghost" style="padding:0.5rem;" title="Edit Habit" onclick="openAddModal('${habit.type}', '${habit.id}')">‚úèÔ∏è</button>
      </div>
    `;
    card.appendChild(topSection);

    // 2. MAIN STATS SECTION
    const stats = document.createElement('div');
    stats.style.cssText = 'display:flex;gap:1rem;margin-bottom:1rem;';

    if (isQuit) {
      // QUIT HABIT: Duration/Streak
      const lastTime = new Date(habit.lastTime);
      const now = new Date();
      const durationSeconds = Math.floor((now - lastTime) / 1000);
      const durationText = formatDuration(durationSeconds);
      const daysClean = Math.floor(durationSeconds / 86400);

      stats.innerHTML = `
        <div class="stat-box green-panel" style="flex:1;">
          <div class="small heading" style="opacity:0.8;">Clean Streak</div>
          <div style="font-size:2rem;font-weight:900;margin-top:0.25rem;">${daysClean} days</div>
          <div class="small" style="opacity:0.8;">${durationText}</div>
        </div>
        <div class="stat-box yellow" style="flex:1;">
          <div class="small heading">Last Slip-up</div>
          <div class="num" style="color:#78350f;">${lastTime.toLocaleDateString()}</div>
          <div class="small muted">${lastTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
      `;
      // Relapse button for Quit Habit
      const relapseBtn = document.createElement('button');
      relapseBtn.className = 'btn btn-danger btn-wide';
      relapseBtn.textContent = '‚ùå Slip Up? Reset Timer';
      relapseBtn.onclick = () => openRelapseModal(habit);
      card.appendChild(stats);
      card.appendChild(relapseBtn);

    } else {
      // BUILD HABIT: Streak, Goal, Progress
      const today = (new Date()).toISOString().split('T')[0];
      const completions = habit.completions || {};
      const todayCount = completions[today] || 0;
      const progressPercent = Math.min(100, (todayCount / habit.dailyGoal) * 100);
      const isComplete = todayCount >= habit.dailyGoal;
      const streak = habit.currentStreak || 0;
      const bestStreak = habit.bestStreak || 0;

      stats.innerHTML = `
        <div class="stat-box green-panel" style="flex:1;">
          <div class="small heading" style="opacity:0.8;">Current Streak</div>
          <div style="font-size:2rem;font-weight:900;margin-top:0.25rem;">${streak} days</div>
          <div class="small" style="opacity:0.8;">Best: ${bestStreak} days</div>
        </div>
        <div class="stat-box yellow" style="flex:1;">
          <div class="small heading">Today's Progress</div>
          <div class="num" style="color:#78350f;">${todayCount}/${habit.dailyGoal}</div>
          <div class="small muted">${habit.unit}</div>
        </div>
      `;
      card.appendChild(stats);

      // Progress bar
      const progressBar = document.createElement('div');
      progressBar.className = 'challenge-progress';
      progressBar.style.margin = '1.5rem 0 1rem';
      progressBar.innerHTML = `<div class="challenge-progress-bar" style="width:${progressPercent}%"></div>`;
      card.appendChild(progressBar);

      // Check-in Button
      const checkInBtn = document.createElement('button');
      checkInBtn.className = `btn btn-wide ${isComplete ? 'btn-ghost' : 'btn-success'}`;
      checkInBtn.textContent = isComplete ? '‚úÖ Goal Complete!' : `+ Check In (${habit.unit})`;
      checkInBtn.onclick = () => toggleBuildHabit(habit.id);
      card.appendChild(checkInBtn);
    }

    return card;
  }

  function renderQuitList() {
    const container = $('quit-list');
    container.innerHTML = '';
    state.quitHabits.forEach(habit => {
      container.appendChild(renderHabitCard(habit));
    });

    if (state.quitHabits.length === 0) {
      container.innerHTML = `<div class="empty">Click '+ Add' above to start tracking a Quit Habit.</div>`;
    }
  }

  function renderBuildList() {
    const container = $('build-list');
    container.innerHTML = '';
    state.buildHabits.forEach(habit => {
      container.appendChild(renderHabitCard(habit));
    });

    if (state.buildHabits.length === 0) {
      container.innerHTML = `<div class="empty">Click '+ Add' above to start tracking a Build Habit.</div>`;
    }
  }

  async function toggleBuildHabit(id) {
    const today = (new Date()).toISOString().split('T')[0];
    let habit = state.buildHabits.find(h => h.id === id);

    if (!habit) return;

    let completions = { ...(habit.completions || {}) };
    let current = completions[today] || 0;

    // Logic: If already complete, reset to 0. If not, increment by 1 (or toggle to goal for a quick complete)
    if (current >= habit.dailyGoal) {
      completions[today] = 0;
      showNotification(`Reset ${habit.name} for today.`);
    } else {
      completions[today] = current + 1;
      if (completions[today] >= habit.dailyGoal) {
        showNotification(`‚úÖ ${habit.name} Goal complete!`);
      } else {
        showNotification(`+1 ${habit.unit} added for ${habit.name}.`);
      }
    }

    const streak = calculateStreak(completions, habit.dailyGoal);
    const best = Math.max(habit.bestStreak || 0, streak);
    
    if (streak > (habit.bestStreak || 0) && streak > 0) {
      showNotification(`üî• New best streak: ${streak} days!`);
    }

    state.buildHabits = state.buildHabits.map(h => 
      h.id === id ? { ...h, completions, currentStreak: streak, bestStreak: best } : h
    );

    saveState();
    renderAll();
  }

  // --- Modal Logic ---

  let currentHabitType = 'quit';
  let editingHabitId = null;

  function openAddModal(type, id = null) {
    if (!state.isPremium && state.quitHabits.length + state.buildHabits.length >= 3 && !id) {
      showNotification("Free plan limit reached (3 habits). Upgrade to Premium to add more.");
      return;
    }
    
    currentHabitType = type;
    editingHabitId = id;
    const modal = $('add-modal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
    
    $('add-title').textContent = id ? `Edit ${type === 'quit' ? 'Quit' : 'Build'} Habit` : `Add New ${type === 'quit' ? 'Quit' : 'Build'} Habit`;
    
    const isQuit = type === 'quit';
    $('add-lasttime-wrap').style.display = isQuit ? 'block' : 'none';
    $('add-goal-wrap').style.display = isQuit ? 'none' : 'block';

    // Clear previous values
    $('add-name').value = '';
    $('add-startdate').value = new Date().toISOString().substring(0, 16);
    $('add-daily-goal').value = 1;
    $('add-unit-label').textContent = 'times';
    
    // Render categories
    const categoryGrid = $('add-category-grid');
    categoryGrid.innerHTML = '';
    const filteredCategories = Object.entries(ALL_CATEGORIES).filter(([, c]) => c.type === type || c.type === 'both');
    let selectedCategory = null;

    if (id) {
      const habit = isQuit 
        ? state.quitHabits.find(h => h.id === id) 
        : state.buildHabits.find(h => h.id === id);
      
      if (habit) {
        $('add-name').value = habit.name;
        selectedCategory = habit.category;
        
        if (isQuit) {
          $('add-startdate').value = habit.lastTime.substring(0, 16);
        } else {
          $('add-daily-goal').value = habit.dailyGoal;
          $('add-unit-label').textContent = habit.unit;
        }
      }
    }
    
    let tempCategorySelection = selectedCategory;

    filteredCategories.forEach(([key, c]) => {
      const btn = document.createElement('button');
      btn.className = `btn ${key === selectedCategory ? 'btn-primary' : 'btn-ghost'}`;
      btn.textContent = c.label;
      btn.type = 'button';
      btn.onclick = () => {
        tempCategorySelection = key;
        
        // Update unit/goal for build habits
        if (!isQuit) {
          const unitInfo = CATEGORY_UNITS[key] || CATEGORY_UNITS.other;
          $('add-daily-goal').value = unitInfo.default;
          $('add-unit-label').textContent = unitInfo.unit;
        }

        // Highlight active button
        categoryGrid.querySelectorAll('button').forEach(b => b.classList.remove('btn-primary'));
        btn.classList.add('btn-primary');
      };
      categoryGrid.appendChild(btn);
    });

    $('btn-save-habit').onclick = () => saveHabit(tempCategorySelection);
  }

  function saveHabit(category) {
    const name = $('add-name').value.trim();
    if (!name) {
      showNotification('Please enter a habit name.');
      return;
    }
    if (!category) {
      showNotification('Please select a category.');
      return;
    }

    const isQuit = currentHabitType === 'quit';
    let newHabitData = {
      id: editingHabitId || uid(),
      name: name,
      icon: HABIT_ICONS[category] || (isQuit ? '‚ùå' : 'üí™'),
      category: category,
      type: currentHabitType,
    };

    if (isQuit) {
      newHabitData.lastTime = $('add-startdate').value + ':00';
    } else {
      newHabitData.dailyGoal = parseInt($('add-daily-goal').value) || 1;
      newHabitData.unit = $('add-unit-label').textContent;
      newHabitData.completions = {};
      newHabitData.currentStreak = 0;
      newHabitData.bestStreak = 0;
    }
    
    if (editingHabitId) {
      const list = isQuit ? state.quitHabits : state.buildHabits;
      const index = list.findIndex(h => h.id === editingHabitId);
      if (index !== -1) {
        // Preserve completions/streaks for build habits
        if (!isQuit) {
          const oldHabit = list[index];
          newHabitData.completions = oldHabit.completions;
          newHabitData.currentStreak = oldHabit.currentStreak;
          newHabitData.bestStreak = oldHabit.bestStreak;
        }
        list[index] = newHabitData;
      }
      showNotification(`${name} updated.`);
    } else {
      if (isQuit) {
        state.quitHabits.push(newHabitData);
      } else {
        state.buildHabits.push(newHabitData);
      }
      showNotification(`${name} added!`);
    }

    saveState();
    closeAddModal();
    renderAll();
  }

  function closeAddModal() {
    const modal = $('add-modal');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
    editingHabitId = null;
  }

  function openRelapseModal(habit) {
    state.relapseModalOpen = true;
    state.emergencyHabit = habit.id;
    const modal = $('relapse-modal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
    
    $('relapse-habit-name').textContent = `Habit: ${habit.name}`;
    $('relapse-date').value = new Date().toISOString().substring(0, 16);
    $('relapse-reason').value = '';
  }

  function closeRelapseModal() {
    state.relapseModalOpen = false;
    state.emergencyHabit = null;
    const modal = $('relapse-modal');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
  }
  
  function confirmRelapse() {
    const habitId = state.emergencyHabit;
    const relapseDateStr = $('relapse-date').value + ':00';
    const relapseReason = $('relapse-reason').value;
    
    state.quitHabits = state.quitHabits.map(h => {
      if (h.id === habitId) {
        const lastTime = new Date(relapseDateStr);
        const now = new Date();
        // Add a relapse history log
        const history = h.relapseHistory || [];
        history.push({ date: lastTime.toISOString(), reason: relapseReason || 'No reason provided' });
        
        return { 
          ...h, 
          lastTime: lastTime.toISOString(),
          relapseHistory: history
        };
      }
      return h;
    });
    
    saveState();
    closeRelapseModal();
    renderAll();
    showNotification('Streak reset. Time to start again! üí™');
  }

  // --- Emergency Modal Logic ---

  let typingInterval = null;
  let coachIndex = 0;
  let emergencyStream = null;

  async function openEmergencyModal(id) {
    const habit = state.quitHabits.find(h => h.id === id);
    if (!habit) return;
    
    state.emergencyHabit = id;
    const overlay = document.getElementById('emergency-overlay');
    overlay.classList.add('show');
    document.getElementById('emergency-habit-name-2').textContent = habit.name;
    
    const videoEl = document.getElementById('emergency-video');
    const fallbackEl = document.getElementById('camera-fallback');
    videoEl.style.display = 'none';
    fallbackEl.style.display = 'flex';
    
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      emergencyStream = stream;
      videoEl.srcObject = stream;
      videoEl.play();
      videoEl.style.display = 'block';
      fallbackEl.style.display = 'none';
      startCoachTyping();
    } catch(err) {
      console.error("Camera access failed:", err);
      fallbackEl.style.display = 'flex';
      startCoachTyping();
    }

    document.getElementById('emergency-done').onclick = () => {
      closeEmergencyModal();
      showNotification('Well done ‚Äì urge passed! Keep going! üí™');
    };
    
    document.getElementById('emergency-relapse').onclick = () => {
      closeEmergencyModal();
      openRelapseModal(habit);
    };
  }

  function closeEmergencyModal() {
    try {
      const overlay = document.getElementById('emergency-overlay');
      overlay.classList.remove('show');
      stopCoachTyping();
      if (emergencyStream) {
        emergencyStream.getTracks().forEach(t => t.stop());
        emergencyStream = null;
      }
    } catch(e) {}
  }

  function startCoachTyping() {
    stopCoachTyping();
    const el = document.getElementById('coach-line');
    if(!el) return;
    let currentText = '';
    let charIndex = 0;
    coachIndex = 0;
    let targetText = COACH_LINES[coachIndex];

    typingInterval = setInterval(() => {
      if(!el) return;
      if(charIndex < targetText.length) {
        currentText += targetText[charIndex];
        el.textContent = currentText;
        charIndex++;
      } else {
        // Pause at the end of the line, then reset and move to the next
        setTimeout(() => {
          currentText = '';
          charIndex = 0;
          coachIndex = (coachIndex + 1) % COACH_LINES.length;
          targetText = COACH_LINES[coachIndex];
        }, 3000); // 3 second pause
      }
    }, 80); // Typing speed
  }

  function stopCoachTyping() {
    if (typingInterval) clearInterval(typingInterval);
    typingInterval = null;
  }
  
  window.openEmergencyModal = openEmergencyModal; // Expose to global scope for HTML onclick
  window.closeEmergencyModal = closeEmergencyModal;
  window.openRelapseModal = openRelapseModal;
  
  // --- Breathing Logic ---

  const BREATH_CONFIG = {
    coherence: { inhale: 5, holdIn: 0, exhale: 5, holdOut: 0, label: 'Coherence (5:5)' },
    box: { inhale: 4, holdIn: 4, exhale: 4, holdOut: 4, label: 'Box (4:4:4:4)' },
    military: { inhale: 4, holdIn: 0, exhale: 6, holdOut: 0, label: 'Military (4:0:6:0)' }
  };

  let audioContext = null;
  let oscillator = null;
  let gainNode = null;
  let running = false;
  let startTime = 0;
  let animId = null;
  let currentConfig = BREATH_CONFIG.coherence;
  const el = {};

  function setupBreathingElements() {
    el.circle = $('breathingCircle');
    el.status = $('coach-line');
    el.startBtn = $('start-breathing');
    el.stopBtn = $('stop-breathing');
    el.modeSelect = $('modeSelect');
    el.freqSelect = $('freqSelect');
  }

  function startTone(frequencyStr) {
    const frequency = parseFloat(frequencyStr);
    if (frequency === 0) return;

    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    // Safety check to ensure we stop any previous tone
    if (oscillator) {
      oscillator.stop();
      oscillator.disconnect();
    }

    oscillator = audioContext.createOscillator();
    gainNode = audioContext.createGain();
    
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
    
    // Connect to gain and destination
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Start with volume 0 and ramp up
    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
    gainNode.gain.linearRampToValueAtTime(0.05, audioContext.currentTime + 0.1); // Low volume
    
    oscillator.start();
  }
  
  function stopTone() {
    if (oscillator) {
      // Fade out to prevent clicks
      gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
      oscillator.stop(audioContext.currentTime + 0.2);
      oscillator.disconnect();
      oscillator = null;
    }
  }

  function animate(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = timestamp - startTime;

    const IN = currentConfig.inhale * 1000;
    const HI = currentConfig.holdIn * 1000;
    const EX = currentConfig.exhale * 1000;
    const HO = currentConfig.holdOut * 1000;
    const cycleMs = IN + HI + EX + HO;
    const pos = elapsed % cycleMs;

    let phase = 'INHALE ‚¨ÜÔ∏è', scale = 0.3;

    if (pos < IN) {
      phase = 'INHALE ‚¨ÜÔ∏è';
      scale = 0.3 + 0.7 * (pos / IN);
    } else if (pos < IN + HI) {
      phase = 'HOLD ‚è∏';
      scale = 1.0;
    } else if (pos < IN + HI + EX) {
      phase = 'EXHALE ‚¨áÔ∏è';
      scale = 1.0 - 0.7 * ((pos - IN - HI) / EX);
    } else {
      phase = 'HOLD ‚è∏';
      scale = 0.3;
    }

    el.circle.style.transform = `scale(${scale})`;
    if (el.status) el.status.textContent = phase;

    animId = requestAnimationFrame(animate);
  }

  function startSession() {
    if (running) stopSession();
    const key = el.modeSelect.value || 'coherence';
    currentConfig = BREATH_CONFIG[key];
    el.startBtn.style.display = 'none';
    el.stopBtn.style.display = '';
    startTone(el.freqSelect.value);
    running = true;
    startTime = 0;
    animId = requestAnimationFrame(animate);
    el.circle.classList.add('glowing');
  }

  function stopSession() {
    running = false;
    if (animId) cancelAnimationFrame(animId);
    stopTone();
    el.startBtn.style.display = '';
    el.stopBtn.style.display = 'none';
    el.circle.style.transform = 'scale(0.3)';
    el.circle.classList.remove('glowing');
    el.status.textContent = 'Session stopped. Click start to begin again.';
  }


  // --- Master Render & Init ---

  function renderAll() {
    // 1. Theme
    if (state.darkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
    $('btn-dark').innerHTML = state.darkMode ? 'üåô' : '‚òÄÔ∏è';
    $('btn-dark').setAttribute('aria-pressed', state.darkMode);
    $('mobile-mode-text').textContent = state.darkMode ? 'Dark Mode' : 'Light Mode';
    $('mobile-menu-dark-toggle').querySelector('.mobile-menu-icon').textContent = state.darkMode ? 'üåô' : '‚òÄÔ∏è';

    // 2. Global UI Visibility
    $('greeting').textContent = `Hey ${state.userData.name || 'Friend'}!`;
    if (state.screen === 'welcome') {
      $('welcome').style.display = 'flex';
      $('app-main').style.display = 'none';
      $('main-header').style.display = 'none';
    } else {
      $('welcome').style.display = 'none';
      $('app-main').style.display = 'block';
      $('main-header').style.display = 'block';
    }

    // 3. Page View Switching
    const pages = ['dashboard', 'ai-coach', 'challenges', 'premium', 'analytics', 'breathing', 'settings'];
    pages.forEach(p => {
      const el = $(`${p}-view`) || $(`${p}-page`) || $(`${p}-section`);
      if (el) el.style.display = state.page === p ? 'block' : 'none';
    });
    
    // 4. Mobile Menu Highlighting
    document.querySelectorAll('.mobile-menu-item').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.page === state.page);
    });
    $('mobile-menu-name').textContent = state.userData.name;
    $('mobile-menu-email').textContent = state.userData.email || 'Not Logged In';
    
    // 5. Premium UI Updates
    updatePremiumUI();
    
    // 6. Dashboard & Habit Lists
    $('quit-count').textContent = state.quitHabits.length;
    $('build-count').textContent = state.buildHabits.length;
    renderQuitList();
    renderBuildList();

    // 7. Page-Specific Renders
    if (state.page === 'challenges') renderChallenges();
    if (state.page === 'analytics') renderAnalytics();
    if (state.page === 'settings') renderSettings();
  }
  
  function updatePremiumUI() {
    state.isPremium = localStorage.getItem('undo_premium') === 'true';
    const isFreeLimitReached = state.quitHabits.length + state.buildHabits.length >= 3;

    // Premium Check: AI Coach & Challenges
    const premiumPages = ['ai-coach', 'challenges'];
    premiumPages.forEach(p => {
      if (state.page === p && !state.isPremium) {
        // Show overlay or redirect for premium pages
        const pageEl = $(`${p}-page`);
        if(pageEl && !pageEl.querySelector('.premium-overlay')) {
          pageEl.insertAdjacentHTML('afterbegin', `
            <div class="premium-overlay" style="position:relative;margin-bottom:1.5rem;padding:2rem;">
              <div style="text-align:center; color:white;">
                <div style="font-size:3rem;margin-bottom:1rem">üëë</div>
                <h3 class="heading" style="font-size:1.75rem;margin-bottom:0.5rem">Upgrade to Premium</h3>
                <p style="opacity:0.9; margin-bottom:1.5rem;">Unlock the ${p.split('-').map(s=>s.charAt(0).toUpperCase() + s.slice(1)).join(' ')} feature and much more!</p>
                <button onclick="changePage('premium')" class="btn btn-gold" style="font-size:1.125rem; padding:1rem;">
                  Go Premium
                </button>
              </div>
            </div>
          `);
        }
      }
    });

    // Premium Check: Habit Limit Banner
    $('habit-limit-banner').style.display = !state.isPremium && isFreeLimitReached ? 'block' : 'none';
    
    // Header Buttons
    const premiumBtn = $('btn-premium');
    const badgeHeader = $('premium-badge-header');
    if (state.isPremium) {
      premiumBtn.style.display = 'none';
      badgeHeader.style.display = 'inline-flex';
    } else {
      premiumBtn.style.display = 'inline-flex';
      badgeHeader.style.display = 'none';
    }

    // Trial End Date
    const trialEndDateEl = $('trial-end-date');
    if (trialEndDateEl && state.userData.premiumTrialEnd) {
      const endDate = new Date(state.userData.premiumTrialEnd);
      trialEndDateEl.textContent = endDate.toLocaleDateString();
    }
  }

  function changePage(page) {
    if (state.page === 'breathing' && running) {
      stopSession(); // Stop breathing session if navigating away
    }
    state.page = page;
    saveState();
    renderAll();
    
    // Close mobile menu if open
    $('mobile-menu-overlay').classList.remove('show');
  }

  function toggleDarkMode() {
    state.darkMode = !state.darkMode;
    localStorage.setItem('undo_dark_mode', state.darkMode);
    renderAll();
  }

  // --- Analytics Logic --- (Placeholder logic, requires full implementation)
  function renderAnalytics() {
    // Analytics is a large section. For now, render basic controls and placeholders.
    const hasHabits = state.quitHabits.length > 0 || state.buildHabits.length > 0;
    $('analyticsMain').style.display = hasHabits ? 'block' : 'none';
    $('emptyState').style.display = hasHabits ? 'none' : 'block';

    if (!hasHabits) return;

    // Populate habit selection dropdown
    const select = $('habitSelectAnalytics');
    select.innerHTML = '';
    const allHabits = [...state.quitHabits, ...state.buildHabits];
    allHabits.forEach(h => {
      const option = document.createElement('option');
      option.value = h.id;
      option.textContent = `${h.icon} ${h.name} (${h.type.toUpperCase()})`;
      select.appendChild(option);
    });

    // Dummy KPI Data
    $('kpiRow').innerHTML = `
      <div class="kpi">
        <div class="small muted">Total Days Tracked</div>
        <div class="num">${Math.floor(Math.random() * 100) + 30}</div>
      </div>
      <div class="kpi">
        <div class="small muted">Best Quit Streak</div>
        <div class="num">${state.quitHabits.reduce((max, h) => Math.max(max, Math.floor((new Date() - new Date(h.lastTime)) / 86400000)), 0)} days</div>
      </div>
      <div class="kpi">
        <div class="small muted">Highest Build Streak</div>
        <div class="num">${state.buildHabits.reduce((max, h) => Math.max(max, h.bestStreak || 0), 0)} days</div>
      </div>
      <div class="kpi">
        <div class="small muted">Relapses / Slips</div>
        <div class="num">${state.quitHabits.reduce((sum, h) => sum + (h.relapseHistory?.length || 0), 0)}</div>
      </div>
    `;

    // Dummy Chart Data (Needs full implementation with Chart.js)
    if (!state.analyticsChart) {
      const ctx7 = $('chart7').getContext('2d');
      state.analyticsChart = new Chart(ctx7, {
        type: 'line',
        data: {
          labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
          datasets: [{
            label: 'Success Rate (%)',
            data: [50, 70, 60, 80, 75, 90, 95],
            borderColor: '#7c3aed',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    } else {
      // Update chart data if needed
    }
  }

  // --- Challenges Logic --- (Placeholder logic)
  function renderChallenges() {
    const container = $('challenges-container');
    container.innerHTML = '';
    
    Object.values(CHALLENGE_PACKS).forEach(challenge => {
      const isActive = state.activeChallenge === challenge.id;
      const card = document.createElement('div');
      card.className = `challenge-card ${isActive ? 'active' : ''}`;
      
      // Calculate progress if active
      let currentDay = 0;
      let progress = 0;
      if (isActive) {
        const start = new Date(state.userData.challengeStart);
        const diffTime = Math.abs(new Date() - start);
        currentDay = Math.min(challenge.duration, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
        progress = (currentDay / challenge.duration) * 100;
      }
      
      // Render Card HTML
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem">
          <div>
            <h3 class="heading" style="font-size:1.25rem;margin-bottom:0.5rem">${challenge.name}</h3>
            <p class="small muted">${challenge.description}</p>
          </div>
          ${isActive ? '<span class="premium-badge">ACTIVE</span>' : ''}
        </div>
        ${isActive ? `
          <div class="challenge-progress">
            <div class="challenge-progress-bar" style="width:${progress}%"></div>
          </div>
          <div style="text-align:center;margin:0.5rem 0">
            <span class="heading">Day ${currentDay} of ${challenge.duration}</span>
            <span class="small muted"> ‚Ä¢ ${progress.toFixed(0)}% Complete</span>
          </div>
        ` : ''}
        <div id="challenge-tasks-${challenge.id}" style="margin-top:1rem;max-height:${isActive ? '400px' : '0'};overflow:hidden;transition:max-height 0.3s ease-in-out;">
          <h4 class="small muted heading" style="margin-bottom:0.5rem;">Key Tasks:</h4>
          ${challenge.tasks.map(task => `
            <div class="task-item ${task.completed ? 'completed' : ''}">
              <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask('${challenge.id}', '${task.task.replace(/'/g, "\\'")}')" />
              <p style="margin:0; font-size:0.9375rem; text-decoration:${task.completed ? 'line-through' : 'none'};">${task.task}</p>
            </div>
          `).join('')}
        </div>
        
        <div style="margin-top:1.5rem; text-align:center;">
          <button class="btn btn-wide ${isActive ? 'btn-danger' : 'btn-primary'}" onclick="handleChallengeAction('${challenge.id}', ${isActive})">
            ${isActive ? 'End Challenge' : 'Start Challenge'}
          </button>
        </div>
      `;

      card.querySelector('.challenge-card').onclick = (e) => {
        // Only toggle tasks view if not clicking a button
        if (!e.target.closest('button') && !e.target.closest('input')) {
          const tasksEl = $(`challenge-tasks-${challenge.id}`);
          if (!isActive) { // Only expand tasks if not currently active
             tasksEl.style.maxHeight = tasksEl.style.maxHeight === '0px' ? '400px' : '0px';
          }
        }
      };

      container.appendChild(card);
    });
  }

  function handleChallengeAction(id, isActive) {
    if (isActive) {
      if (confirm("Are you sure you want to end this challenge?")) {
        state.activeChallenge = null;
        state.userData.challengeStart = null;
        saveState();
        showNotification("Challenge ended.");
        renderAll();
      }
    } else {
      if (!state.isPremium) {
        showNotification("Challenges are a Premium feature. Please upgrade to start.");
        changePage('premium');
        return;
      }
      if (state.activeChallenge) {
        showNotification("You can only have one active challenge at a time. End your current one first.");
        return;
      }
      
      const challenge = CHALLENGE_PACKS[id];
      if (confirm(`Start the üéØ ${challenge.name} challenge?`)) {
        state.activeChallenge = id;
        state.userData.challengeStart = new Date().toISOString();
        
        // Reset tasks in the challenge definition for the new start
        challenge.tasks.forEach(t => t.completed = false);
        
        saveState();
        showNotification(`${challenge.name} started! Good luck!`);
        renderAll();
      }
    }
  }

  function toggleTask(challengeId, taskText) {
    if (!state.activeChallenge || state.activeChallenge !== challengeId) return;

    const challenge = CHALLENGE_PACKS[challengeId];
    if (challenge) {
      const task = challenge.tasks.find(t => t.task === taskText);
      if (task) {
        task.completed = !task.completed;
        saveState();
        renderAll(); // Re-render to update UI
        showNotification(task.completed ? 'Task completed! ‚úÖ' : 'Task unchecked.');
      }
    }
  }

  // --- Settings Logic ---
  function renderSettings() {
    $('user-email-setting').textContent = state.userData.email || 'Not Logged In';
    $('setting-name').value = state.userData.name || '';
    $('setting-why').value = state.userData.why || '';
  }

  function saveProfileSettings() {
    state.userData.name = $('setting-name').value.trim();
    state.userData.why = $('setting-why').value.trim();
    saveState();
    showNotification('Profile saved! AI Coach context updated.');
    renderAll();
  }

  function startTrial() {
    if (state.isPremium) {
      showNotification("You are already Premium!");
      return;
    }
    state.isPremium = true;
    localStorage.setItem('undo_premium', 'true');
    state.userData.premiumTrialStart = new Date().toISOString();
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + 7);
    state.userData.premiumTrialEnd = endDate.toISOString();
    saveState();
    showNotification("üëë Premium Trial Started! Enjoy the features!");
    changePage('dashboard');
  }

  function exportAllData() {
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `undo_data_export_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showNotification("Data export successful!");
  }

  function importAllData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedState = JSON.parse(e.target.result);
        if (importedState && importedState.quitHabits && importedState.buildHabits) {
          // Merge imported data over current state (excluding transient things like screen/page)
          Object.assign(state, {
            ...importedState,
            screen: state.isLoggedIn ? 'dashboard' : 'welcome',
            page: 'dashboard',
            questionIndex: 0,
            answers: {},
            chatHistory: importedState.chatHistory || []
          });
          
          // Re-establish login status and email from the imported data, or keep current login if more recent
          state.isLoggedIn = state.isLoggedIn || importedState.isLoggedIn || false;
          if (importedState.userData && importedState.userData.email) {
            state.userData.email = importedState.userData.email;
          }

          localStorage.setItem('undo_premium', state.isPremium);
          saveState();
          showNotification("Data import successful! Reloading dashboard...");
          renderAll();
        } else {
          throw new Error("Invalid UNDO data structure.");
        }
      } catch (error) {
        console.error("Import error:", error);
        showNotification(`Data import failed: ${error.message}`);
      }
    };
    reader.readAsText(file);
  }

  function resetAllData() {
    if (confirm("Are you absolutely sure you want to clear ALL your local data? This action is permanent.")) {
      localStorage.removeItem('undo_state');
      localStorage.removeItem('undo_premium');
      localStorage.removeItem('undo_dark_mode');
      
      // Force reload to clear all in-memory state
      window.location.reload(); 
    }
  }

  function logout() {
    // Clear login flag but keep user data (habits) in local storage
    state.isLoggedIn = false;
    saveState();
    
    // Attempt to sign out of Google (Google Sign-In usually requires specific library calls, but simply showing the sign-in screen again is enough for this single-file app)
    showNotification("You have been logged out.");
    window.location.reload();
  }
  
  // --- Initialization ---

  function init() {
    // Load environment variables (from the included .env file content if running locally)
    // NOTE: This is a placeholder that expects a global `window.env` object if run via a local server setup that includes the .env file. If double-clicked directly, this part needs adjustment (or you hardcode the keys for testing).
    // For this demonstration, we'll try to fetch the keys as expected.
    
    fetch('.env')
      .then(r => r.text())
      .then(text => {
        const lines = text.split('\n').filter(line => line.trim() && !line.startsWith('#'));
        lines.forEach(line => {
          const [key, value] = line.split('=').map(s => s.trim().replace(/"/g, ''));
          if (key && value) {
            state.env[key] = value;
          }
        });
      })
      .catch(e => {
        console.warn("Could not load .env file. Assuming keys are hardcoded or unavailable.", e);
      })
      .finally(() => {
        GOOGLE_CLIENT_ID = state.env.GOOGLE_CLIENT_ID || 'YOUR_GOOGLE_CLIENT_ID_PLACEHOLDER';
        OPENROUTER_API_KEY = state.env.OPENROUTER_API_KEY;
        
        loadState();
        setupBreathingElements();
        
        // Final check before rendering based on login status
        if (!state.isLoggedIn) {
          state.screen = 'welcome';
          $('login-step').style.display = 'block';
          $('question-wrap').style.display = 'none';
          
          // Set the client ID dynamically for the Google Sign-In button
          const gOnload = document.getElementById('g_id_onload');
          if (gOnload) gOnload.setAttribute('data-client_id', GOOGLE_CLIENT_ID);

        } else {
          // If logged in, skip welcome screen and go to dashboard
          showLoading('Loading your data...');
          setTimeout(() => {
            finishOnboarding();
          }, 1000);
        }
        
        // Initial render for event listeners to be attached correctly
        renderAll();
      });
  }
  
  // Attach all event listeners
  document.addEventListener('DOMContentLoaded', () => {
    init();

    // Onboarding Buttons
    $('btn-next-question').addEventListener('click', handleQuestionSubmit);
    $('btn-back-question').addEventListener('click', () => {
      if (state.questionIndex > 0) {
        state.questionIndex--;
        renderQuestion();
        saveState();
      }
    });

    // Navigation Buttons
    document.querySelectorAll('[id^="btn-"]').forEach(btn => {
      if (btn.id.startsWith('btn-') && btn.id !== 'btn-next-question' && btn.id !== 'btn-back-question' && btn.id !== 'btn-burger' && btn.id !== 'btn-dark' && btn.id !== 'btn-logout') {
        const page = btn.id.split('-').pop();
        btn.addEventListener('click', () => changePage(page));
      }
    });
    
    // Mobile Menu Toggles
    $('btn-burger').addEventListener('click', () => $('mobile-menu-overlay').classList.add('show'));
    $('mobile-menu-overlay').addEventListener('click', (e) => {
        if (e.target.id === 'mobile-menu-overlay') e.target.classList.remove('show');
    });
    document.querySelectorAll('.mobile-menu-item').forEach(btn => {
        if(btn.dataset.page) btn.addEventListener('click', () => changePage(btn.dataset.page));
    });

    // Dashboard Buttons
    $('add-quit').addEventListener('click', () => openAddModal('quit'));
    $('add-build').addEventListener('click', () => openAddModal('build'));
    $('close-add').addEventListener('click', closeAddModal);
    $('close-relapse').addEventListener('click', closeRelapseModal);
    $('btn-confirm-relapse').addEventListener('click', confirmRelapse);
    
    // Premium & Trial
    if ($('start-trial-btn')) $('start-trial-btn').addEventListener('click', startTrial);
    if ($('upgrade-from-banner')) $('upgrade-from-banner').addEventListener('click', () => changePage('premium'));
    
    // AI Coach Chat
    if ($('chat-send')) $('chat-send').addEventListener('click', () => handleChatMessage($('chat-input').value));
    if ($('chat-input')) $('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChatMessage(e.target.value); });
    document.addEventListener('click', (e) => { if (e.target.classList.contains('quick-question-btn')) handleChatMessage(e.target.dataset.question); });
    
    // Breathing
    if ($('start-breathing')) $('start-breathing').addEventListener('click', startSession);
    if ($('stop-breathing')) $('stop-breathing').addEventListener('click', stopSession);
    
    // Settings
    if ($('btn-dark')) $('btn-dark').addEventListener('click', toggleDarkMode);
    if ($('mobile-menu-dark-toggle')) $('mobile-menu-dark-toggle').addEventListener('click', toggleDarkMode);
    if ($('save-profile')) $('save-profile').addEventListener('click', saveProfileSettings);
    if ($('export-data-btn')) $('export-data-btn').addEventListener('click', exportAllData);
    if ($('import-data-file')) $('import-data-file').addEventListener('change', importAllData);
    if ($('import-data-btn')) $('import-data-btn').addEventListener('click', () => $('import-data-file').click());
    if ($('reset-data-btn')) $('reset-data-btn').addEventListener('click', resetAllData);
    if ($('btn-logout')) $('btn-logout').addEventListener('click', logout);
    if ($('mobile-menu-logout')) $('mobile-menu-logout').addEventListener('click', logout);
    
    // Initial check for dark mode preference
    if(state.darkMode) document.documentElement.classList.add('dark');
  });

</script>
</body>
</html>
